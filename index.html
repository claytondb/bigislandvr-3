<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Explore the Big Island of Hawaii through immersive 360¬∞ Street View panoramas with ambient audio">
    <meta name="theme-color" content="#0D3B66">
    <meta property="og:title" content="Big Island VR - Explore Hawai ªi">
    <meta property="og:description" content="Immersive 360¬∞ virtual tour of the Big Island of Hawaii">
    <meta property="og:type" content="website">
    <title>Big Island VR - Explore Hawai ªi</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Inter:wght@400;500;600&family=Lora:ital@1&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js" defer></script>
    
    <style>
        :root {
            --color-kona-blue: #0D3B66;
            --color-pacific-teal: #1A6B7C;
            --color-shallow-water: #3DA5D9;
            --color-seafoam: #7FCDCD;
            --color-lava-black: #1A1A1A;
            --color-pahoehoe: #2D2D2D;
            --color-volcanic-ash: #4A4A4A;
            --color-cinder: #6B6B6B;
            --color-plumeria: #FAF8F5;
            --color-hibiscus: #E63946;
            --color-pikake: #F4A261;
            --color-ti-leaf: #2A9D8F;
            --color-orchid: #9B5DE5;
            --color-gold: #FFD700;
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-display: 'DM Sans', var(--font-primary);
            --font-accent: 'Lora', Georgia, serif;
            --space-1: 4px; --space-2: 8px; --space-3: 12px; --space-4: 16px; --space-5: 24px; --space-6: 32px;
            --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 24px;
            --duration-fast: 200ms; --duration-normal: 300ms; --duration-slow: 500ms;
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-natural: cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--color-lava-black); color: var(--color-plumeria); font-family: var(--font-primary); overflow: hidden; -webkit-font-smoothing: antialiased; }
        #viewer { width: 100vw; height: 100vh; position: relative; }
        #street-view-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        
        /* =====================================================
           ENHANCED LOADING SCREEN
           ===================================================== */
        #loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, var(--color-kona-blue) 0%, var(--color-pacific-teal) 30%, var(--color-lava-black) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; transition: opacity 1.2s var(--ease-out-expo), filter 0.8s ease; overflow: hidden; }
        #loading.hidden { opacity: 0; pointer-events: none; filter: blur(10px); }
        #loading::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 200'%3E%3Cpath d='M0 200 L50 180 Q100 120 150 140 Q180 160 200 100 Q220 60 250 80 Q280 100 320 60 Q350 30 380 50 L400 40 L400 200 Z' fill='%23000' fill-opacity='0.3'/%3E%3C/svg%3E") center bottom/100% auto no-repeat; animation: islandShimmer 4s ease-in-out infinite; }
        @keyframes islandShimmer { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        .loading-stars { position: absolute; top: 0; left: 0; right: 0; bottom: 50%; pointer-events: none; }
        .loading-stars::before { content: '‚ú¶'; position: absolute; top: 15%; left: 20%; font-size: 0.5rem; color: rgba(255,255,255,0.4); animation: starTwinkle 2s ease-in-out infinite; }
        .loading-stars::after { content: '‚ú¶'; position: absolute; top: 25%; right: 30%; font-size: 0.3rem; color: rgba(255,255,255,0.3); animation: starTwinkle 2.5s ease-in-out 0.5s infinite; }
        @keyframes starTwinkle { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }
        .loading-logo { font-size: 5rem; margin-bottom: var(--space-4); animation: floatRotate 4s ease-in-out infinite; filter: drop-shadow(0 0 20px rgba(127, 205, 205, 0.5)); }
        @keyframes floatRotate { 0%, 100% { transform: translateY(0) rotate(-3deg); } 50% { transform: translateY(-15px) rotate(3deg); } }
        #loading h1 { font-family: var(--font-display); font-size: 3rem; font-weight: 600; margin-bottom: var(--space-2); background: linear-gradient(135deg, var(--color-plumeria) 0%, var(--color-seafoam) 50%, var(--color-pikake) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-shadow: 0 4px 30px rgba(127, 205, 205, 0.3); background-size: 200% 100%; animation: gradientShift 3s ease infinite; }
        @keyframes gradientShift { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .loading-subtitle { font-family: var(--font-accent); font-style: italic; color: var(--color-seafoam); font-size: 1.2rem; margin-bottom: var(--space-5); opacity: 0.9; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .loading-progress { width: 320px; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden; margin-bottom: var(--space-3); position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
        .loading-progress::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: repeating-linear-gradient(90deg, transparent, transparent 8px, rgba(255,255,255,0.05) 8px, rgba(255,255,255,0.05) 16px); }
        .loading-progress-bar { height: 100%; background: linear-gradient(90deg, var(--color-pacific-teal), var(--color-ti-leaf), var(--color-pikake), var(--color-hibiscus)); border-radius: 4px; width: 0%; animation: progressEnhanced 2.5s ease-out forwards; background-size: 300% 100%; position: relative; }
        .loading-progress-bar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%); animation: shimmerSlide 1.5s ease-in-out infinite; }
        @keyframes progressEnhanced { 0% { width: 0%; } 30% { width: 40%; } 60% { width: 75%; } 100% { width: 100%; } }
        @keyframes shimmerSlide { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .loading-tip { color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; max-width: 300px; text-align: center; line-height: 1.4; animation: tipFade 4s ease-in-out infinite; margin-bottom: var(--space-3); }
        @keyframes tipFade { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .loading-location { color: var(--color-seafoam); font-size: 0.9rem; font-weight: 500; }
        
        /* =====================================================
           VISUAL EFFECTS LAYERS
           ===================================================== */
        #transition-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-lava-black); z-index: 15; opacity: 0; pointer-events: none; transition: opacity 0.8s ease-in-out, filter 0.5s ease; }
        #transition-overlay.active { opacity: 1; }
        #transition-overlay.blur-active { filter: blur(20px); backdrop-filter: blur(10px); }
        #transition-overlay.flyover { background: linear-gradient(180deg, rgba(135,206,235,0.3) 0%, rgba(13,59,102,0.6) 100%); opacity: 0.7; }
        
        /* Vignette Effect */
        #vignette-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 16; opacity: 0; transition: opacity var(--duration-normal) ease; background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.3) 80%, rgba(0,0,0,0.6) 100%); }
        #vignette-layer.active { opacity: 1; }
        #vignette-layer.strong { background: radial-gradient(ellipse at center, transparent 30%, rgba(0,0,0,0.4) 70%, rgba(0,0,0,0.8) 100%); }
        
        /* Lens Flare Effect */
        #lens-flare { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 19; opacity: 0; transition: opacity 0.5s ease; }
        #lens-flare.active { opacity: 1; }
        .flare-main { position: absolute; width: 150px; height: 150px; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,200,0.8) 0%, rgba(255,200,100,0.4) 30%, transparent 70%); filter: blur(2px); animation: flareGlow 3s ease-in-out infinite; }
        .flare-secondary { position: absolute; width: 80px; height: 80px; border-radius: 50%; background: radial-gradient(circle, rgba(255,180,100,0.6) 0%, transparent 70%); filter: blur(4px); }
        .flare-streak { position: absolute; width: 200px; height: 4px; background: linear-gradient(90deg, transparent, rgba(255,255,200,0.6), transparent); transform-origin: left center; filter: blur(1px); }
        .flare-hexagon { position: absolute; width: 30px; height: 30px; background: rgba(100,200,255,0.3); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); filter: blur(2px); }
        @keyframes flareGlow { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }
        
        /* Bloom/Glow Effect */
        #bloom-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 14; opacity: 0; transition: opacity var(--duration-normal) ease; mix-blend-mode: screen; }
        #bloom-layer.active { opacity: 1; }
        #bloom-layer.day { background: radial-gradient(ellipse at 50% 15%, rgba(255,255,240,0.5) 0%, rgba(255,250,220,0.3) 20%, transparent 60%), radial-gradient(ellipse at 50% 0%, rgba(255,255,255,0.4) 0%, transparent 40%); }
        #bloom-layer.golden { background: radial-gradient(ellipse at 70% 25%, rgba(255,200,100,0.6) 0%, rgba(255,150,50,0.3) 25%, transparent 55%), radial-gradient(ellipse at 30% 40%, rgba(255,180,80,0.25) 0%, transparent 45%); }
        
        /* Color Grading Filters */
        #color-grade { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 13; opacity: 0; transition: opacity var(--duration-normal) ease; mix-blend-mode: overlay; }
        #color-grade.active { opacity: 1; }
        #color-grade.vivid { background: linear-gradient(135deg, rgba(0,100,150,0.1) 0%, rgba(255,100,50,0.1) 100%); filter: saturate(1.3) contrast(1.1); }
        #color-grade.cinematic { background: linear-gradient(180deg, rgba(0,30,60,0.15) 0%, rgba(40,20,0,0.1) 100%); filter: contrast(1.15) saturate(0.9); }
        #color-grade.vintage { background: linear-gradient(135deg, rgba(100,80,60,0.2) 0%, rgba(60,40,30,0.15) 100%); filter: sepia(0.2) contrast(1.05) saturate(0.85); }
        #color-grade.tropical { background: linear-gradient(180deg, rgba(0,150,200,0.08) 0%, rgba(100,200,100,0.08) 100%); filter: saturate(1.4) brightness(1.05); }
        
        /* Enhanced Time-of-Day Atmosphere */
        #atmosphere-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 18; transition: all 1.2s ease; }
        .time-dawn { background: linear-gradient(180deg, rgba(255, 140, 80, 0.25) 0%, rgba(255, 180, 120, 0.2) 20%, rgba(255, 100, 80, 0.15) 40%, rgba(180, 100, 150, 0.1) 60%, transparent 80%); }
        .time-dawn::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse at 80% 10%, rgba(255,200,100,0.3) 0%, transparent 40%); animation: sunRise 10s ease-in-out infinite; }
        @keyframes sunRise { 0%, 100% { opacity: 0.8; } 50% { opacity: 1; } }
        .time-day { background: linear-gradient(180deg, rgba(135, 206, 250, 0.05) 0%, transparent 30%); }
        .time-golden { background: linear-gradient(180deg, rgba(255, 180, 50, 0.3) 0%, rgba(255, 140, 60, 0.25) 25%, rgba(255, 100, 80, 0.15) 50%, transparent 75%); }
        .time-golden::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse at 70% 40%, rgba(255,200,100,0.4) 0%, transparent 50%); }
        .time-dusk { background: linear-gradient(180deg, rgba(255, 100, 60, 0.3) 0%, rgba(200, 80, 100, 0.25) 25%, rgba(120, 60, 140, 0.2) 50%, rgba(40, 30, 80, 0.15) 100%); }
        .time-dusk::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse at 20% 60%, rgba(255,120,80,0.3) 0%, transparent 50%); animation: sunSet 8s ease-in-out infinite; }
        @keyframes sunSet { 0%, 100% { opacity: 0.7; transform: translateY(0); } 50% { opacity: 1; transform: translateY(5%); } }
        .time-night { background: linear-gradient(180deg, rgba(5, 10, 30, 0.6) 0%, rgba(10, 15, 40, 0.55) 40%, rgba(15, 20, 50, 0.5) 100%); }
        .time-night::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 50%; background: radial-gradient(ellipse at 30% 20%, rgba(200, 220, 255, 0.08) 0%, transparent 50%), radial-gradient(ellipse at 70% 10%, rgba(180, 200, 255, 0.05) 0%, transparent 30%); }
        .time-night::after { content: 'üåô'; position: absolute; top: 10%; right: 15%; font-size: 2rem; opacity: 0.4; filter: drop-shadow(0 0 10px rgba(200,220,255,0.5)); animation: moonGlow 5s ease-in-out infinite; }
        @keyframes moonGlow { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.05); } }
        
        #mist-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 17; opacity: 0; transition: opacity 1s ease; background: radial-gradient(ellipse at 50% 120%, rgba(200, 210, 220, 0.6) 0%, rgba(180, 190, 200, 0.3) 40%, transparent 70%); }
        #mist-layer.active { opacity: 1; animation: mistDrift 20s ease-in-out infinite; }
        @keyframes mistDrift { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-20px) scale(1.05); } }
        #mist-layer.volcanic { background: radial-gradient(ellipse at 50% 100%, rgba(150, 140, 130, 0.5) 0%, rgba(120, 115, 110, 0.3) 50%, transparent 80%); }
        
        #info { position: absolute; top: var(--space-5); left: var(--space-5); background: rgba(26, 26, 26, 0.85); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); padding: var(--space-4) var(--space-5); border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.08); z-index: 50; max-width: 320px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.05); animation: fadeUp var(--duration-slow) var(--ease-out-expo); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .info-brand { display: flex; align-items: center; gap: var(--space-2); font-family: var(--font-display); font-size: 0.875rem; font-weight: 500; color: var(--color-seafoam); margin-bottom: var(--space-3); padding-bottom: var(--space-3); border-bottom: 1px solid rgba(255, 255, 255, 0.08); }
        #location-name { font-family: var(--font-display); font-size: 1.25rem; font-weight: 600; margin-bottom: var(--space-1); line-height: 1.2; }
        #location-desc { font-size: 0.875rem; color: rgba(255, 255, 255, 0.6); line-height: 1.4; margin-bottom: var(--space-3); }
        .location-dots { display: flex; gap: var(--space-1); margin-bottom: var(--space-2); flex-wrap: wrap; }
        .location-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--color-volcanic-ash); cursor: pointer; transition: all var(--duration-fast) var(--ease-natural); }
        .location-dot:hover { transform: scale(1.3); background: var(--color-seafoam); }
        .location-dot.active { width: 10px; height: 10px; background: var(--color-ti-leaf); box-shadow: 0 0 10px rgba(42, 157, 143, 0.5); }
        .location-dot.visited { background: var(--color-seafoam); }
        #location-counter { font-size: 0.75rem; color: var(--color-seafoam); font-weight: 500; letter-spacing: 0.02em; }
        
        #location-selector { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); z-index: 50; animation: fadeUp var(--duration-slow) var(--ease-out-expo) 0.1s both; }
        #location-selector #destination-search { width: 320px; text-align: center; }
        #location-dropdown { background: rgba(26, 26, 26, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: var(--radius-md); color: var(--color-plumeria); padding: var(--space-3) var(--space-5); padding-right: var(--space-6); font-family: var(--font-primary); font-size: 0.95rem; cursor: pointer; min-width: 280px; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%237FCDCD' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; transition: all var(--duration-fast) var(--ease-natural); }
        #location-dropdown:hover { border-color: var(--color-seafoam); }
        #location-dropdown:focus { outline: 2px solid var(--color-shallow-water); outline-offset: 2px; }
        #location-dropdown option { background: var(--color-pahoehoe); color: var(--color-plumeria); padding: var(--space-2); }
        #location-dropdown optgroup { background: var(--color-lava-black); color: var(--color-seafoam); font-weight: 600; }
        
        #mini-map-container { position: absolute; bottom: var(--space-5); left: var(--space-5); width: 200px; height: 150px; background: rgba(26, 26, 26, 0.85); backdrop-filter: blur(20px); border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.08); overflow: hidden; z-index: 50; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); animation: fadeUp var(--duration-slow) var(--ease-out-expo) 0.2s both; }
        #mini-map { width: 100%; height: 100%; }
        .mini-map-label { position: absolute; bottom: 0; left: 0; right: 0; padding: var(--space-2); background: linear-gradient(transparent, rgba(0,0,0,0.7)); font-size: 0.7rem; color: var(--color-seafoam); text-align: center; pointer-events: none; }
        
        #effects { position: absolute; top: var(--space-5); right: var(--space-5); background: rgba(26, 26, 26, 0.85); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); padding: var(--space-4); border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.08); z-index: 50; min-width: 240px; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.05); animation: fadeUp var(--duration-slow) var(--ease-out-expo) 0.1s both; }
        .effects-header { display: flex; align-items: center; gap: var(--space-2); font-size: 0.875rem; font-weight: 500; color: var(--color-seafoam); margin-bottom: var(--space-3); padding-bottom: var(--space-3); border-bottom: 1px solid rgba(255, 255, 255, 0.08); }
        .effects-section { margin-bottom: var(--space-4); padding-bottom: var(--space-3); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .effects-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .section-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--color-seafoam); margin-bottom: var(--space-2); opacity: 0.7; }
        .effect-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-3); gap: var(--space-3); }
        .effect-row:last-child { margin-bottom: 0; }
        .effect-label { display: flex; align-items: center; gap: var(--space-2); font-size: 0.875rem; color: var(--color-plumeria); }
        .effect-icon { font-size: 1rem; }
        
        .toggle-switch { width: 52px; height: 28px; background: linear-gradient(135deg, var(--color-pahoehoe), var(--color-volcanic-ash)); border-radius: 14px; position: relative; cursor: pointer; transition: all var(--duration-fast) var(--ease-natural); flex-shrink: 0; }
        .toggle-switch::after { content: ''; position: absolute; width: 22px; height: 22px; background: linear-gradient(135deg, var(--color-plumeria), #E0E0E0); border-radius: 50%; top: 3px; left: 3px; transition: transform var(--duration-fast) var(--ease-out-expo); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
        .toggle-switch.on { background: linear-gradient(135deg, var(--color-pacific-teal), var(--color-ti-leaf)); }
        .toggle-switch.on::after { transform: translateX(24px); }
        
        .slider-row { margin-bottom: var(--space-3); }
        .slider-label { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-2); font-size: 0.8rem; color: rgba(255, 255, 255, 0.8); }
        .slider-value { color: var(--color-seafoam); font-weight: 500; font-size: 0.75rem; }
        .effect-slider { -webkit-appearance: none; width: 100%; height: 6px; background: var(--color-volcanic-ash); border-radius: 3px; outline: none; }
        .effect-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: linear-gradient(135deg, var(--color-plumeria), #E0E0E0); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); transition: transform var(--duration-fast) var(--ease-natural); }
        .effect-slider::-webkit-slider-thumb:hover { transform: scale(1.15); }
        
        .time-selector { display: flex; gap: var(--space-2); justify-content: space-between; }
        .time-btn { flex: 1; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--radius-sm); padding: var(--space-2) var(--space-1); cursor: pointer; font-size: 0.75rem; color: var(--color-plumeria); transition: all var(--duration-fast) var(--ease-natural); text-align: center; }
        .time-btn:hover { background: rgba(255, 255, 255, 0.1); border-color: var(--color-seafoam); }
        .time-btn.active { background: rgba(42, 157, 143, 0.3); border-color: var(--color-ti-leaf); }
        .time-btn-icon { font-size: 1.2rem; display: block; margin-bottom: 2px; }
        
        .volume-section { margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px solid rgba(255, 255, 255, 0.08); }
        .volume-label { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-2); font-size: 0.75rem; color: rgba(255, 255, 255, 0.6); }
        .volume-slider { -webkit-appearance: none; width: 100%; height: 6px; background: linear-gradient(90deg, var(--color-ti-leaf) 0%, var(--color-volcanic-ash) 100%); border-radius: 3px; outline: none; }
        .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: linear-gradient(135deg, var(--color-plumeria), #E0E0E0); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
        
        #audio-unlock { display: none; position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, var(--color-ti-leaf), var(--color-pacific-teal)); border: none; padding: var(--space-3) var(--space-5); border-radius: var(--radius-xl); color: white; font-family: var(--font-primary); font-size: 0.9rem; font-weight: 500; cursor: pointer; z-index: 200; box-shadow: 0 4px 20px rgba(42, 157, 143, 0.4); animation: pulse 2s ease-in-out infinite; }
        #audio-unlock.visible { display: flex; align-items: center; gap: var(--space-2); }
        @keyframes pulse { 0%, 100% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } }
        
        #controls { position: absolute; bottom: var(--space-5); left: 50%; transform: translateX(-50%); display: flex; gap: var(--space-3); z-index: 50; animation: fadeUp var(--duration-slow) var(--ease-out-expo) 0.2s both; }
        .control-btn { background: rgba(26, 26, 26, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--color-plumeria); padding: var(--space-3) var(--space-5); border-radius: var(--radius-md); cursor: pointer; font-family: var(--font-primary); font-size: 0.875rem; font-weight: 500; transition: all var(--duration-fast) var(--ease-natural); display: flex; align-items: center; gap: var(--space-2); box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); }
        .control-btn:hover { background: rgba(42, 157, 143, 0.2); border-color: rgba(42, 157, 143, 0.4); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4); }
        .control-btn:active { transform: translateY(0); }
        .control-btn.active { background: rgba(42, 157, 143, 0.3); border-color: var(--color-ti-leaf); box-shadow: 0 0 20px rgba(42, 157, 143, 0.3); }
        
        #hints { position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%); background: rgba(26, 26, 26, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: var(--space-2) var(--space-4); border-radius: var(--radius-xl); font-size: 0.75rem; color: rgba(255, 255, 255, 0.6); z-index: 50; white-space: nowrap; animation: fadeUp var(--duration-slow) var(--ease-out-expo) 0.3s both; }
        kbd { background: rgba(255, 255, 255, 0.1); padding: 2px 8px; border-radius: var(--radius-sm); margin: 0 2px; font-family: var(--font-primary); font-size: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.1); }
        
        #rain-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; opacity: 0; transition: opacity var(--duration-slow) var(--ease-natural); }
        #rain-canvas.active { opacity: 1; }
        
        /* Scene Animation Shader Overlay */
        #shader-animation-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 12; opacity: 0; transition: opacity 0.5s ease; mix-blend-mode: overlay; }
        #shader-animation-canvas.active { opacity: 0.8; }
        
        /* =====================================================
           PARTICLE SYSTEMS
           ===================================================== */
        #particles-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 21; }
        
        /* Firefly container */
        #fireflies-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 22; opacity: 0; transition: opacity 1s ease; }
        #fireflies-container.active { opacity: 1; }
        .firefly { position: absolute; width: 6px; height: 6px; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,150,1) 0%, rgba(200,255,100,0.8) 40%, transparent 70%); box-shadow: 0 0 10px 4px rgba(255,255,100,0.6), 0 0 20px 8px rgba(200,255,100,0.3); animation: fireflyFloat 8s ease-in-out infinite, fireflyGlow 2s ease-in-out infinite; }
        @keyframes fireflyFloat { 0% { transform: translate(0, 0); } 25% { transform: translate(30px, -20px); } 50% { transform: translate(10px, 30px); } 75% { transform: translate(-20px, 10px); } 100% { transform: translate(0, 0); } }
        @keyframes fireflyGlow { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
        
        /* Butterfly container */
        #butterflies-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 22; opacity: 0; transition: opacity 1s ease; }
        #butterflies-container.active { opacity: 1; }
        .butterfly { position: absolute; font-size: 1.5rem; animation: butterflyFly 15s ease-in-out infinite; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3)); }
        @keyframes butterflyFly { 0% { transform: translate(0, 0) rotate(0deg) scale(1); } 20% { transform: translate(100px, -50px) rotate(10deg) scale(1.1); } 40% { transform: translate(50px, 20px) rotate(-5deg) scale(0.9); } 60% { transform: translate(150px, -30px) rotate(15deg) scale(1.05); } 80% { transform: translate(80px, 40px) rotate(-10deg) scale(0.95); } 100% { transform: translate(0, 0) rotate(0deg) scale(1); } }
        
        /* Falling leaves container */
        #leaves-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 22; opacity: 0; transition: opacity 1s ease; overflow: hidden; }
        #leaves-container.active { opacity: 1; }
        .leaf { position: absolute; font-size: 1.2rem; top: -30px; animation: leafFall linear infinite; }
        @keyframes leafFall { 0% { transform: translateY(-30px) rotate(0deg) translateX(0); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg) translateX(100px); opacity: 0; } }
        
        /* Volcanic ash container */
        #ash-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 22; opacity: 0; transition: opacity 1s ease; overflow: hidden; }
        #ash-container.active { opacity: 1; }
        .ash-particle { position: absolute; width: 3px; height: 3px; background: rgba(80, 70, 60, 0.7); border-radius: 50%; top: -10px; animation: ashFall linear infinite; }
        @keyframes ashFall { 0% { transform: translateY(-10px) translateX(0); opacity: 0; } 10% { opacity: 0.8; } 90% { opacity: 0.6; } 100% { transform: translateY(110vh) translateX(50px); opacity: 0; } }
        
        /* Ocean spray container */
        #spray-container { position: absolute; bottom: 0; left: 0; right: 0; height: 30%; pointer-events: none; z-index: 22; opacity: 0; transition: opacity 1s ease; }
        #spray-container.active { opacity: 1; }
        .spray-particle { position: absolute; bottom: 0; width: 4px; height: 4px; background: rgba(255, 255, 255, 0.6); border-radius: 50%; animation: sprayRise 3s ease-out infinite; }
        @keyframes sprayRise { 0% { transform: translateY(0) scale(1); opacity: 0.8; } 100% { transform: translateY(-150px) scale(0.3); opacity: 0; } }
        
        /* Screenshot overlay styles */
        #screenshot-watermark { position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); padding: 8px 16px; border-radius: 8px; color: white; font-family: var(--font-display); font-size: 0.9rem; z-index: 500; display: none; }
        #screenshot-watermark.visible { display: flex; align-items: center; gap: 8px; }
        #screenshot-stamp { position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); padding: 8px 16px; border-radius: 8px; color: white; font-family: var(--font-primary); font-size: 0.8rem; z-index: 500; display: none; }
        #screenshot-stamp.visible { display: block; }
        #screenshot-flash { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 600; opacity: 0; pointer-events: none; transition: opacity 0.1s ease; }
        #screenshot-flash.flash { opacity: 0.8; }
        
        .screenshot-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, var(--color-pacific-teal), var(--color-ti-leaf)); border: none; border-radius: var(--radius-md); color: white; font-family: var(--font-primary); font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform var(--duration-fast), box-shadow var(--duration-fast); box-shadow: 0 4px 15px rgba(42, 157, 143, 0.3); }
        .screenshot-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(42, 157, 143, 0.4); }
        .screenshot-btn:active { transform: translateY(0); }
        
        #fullscreen-btn { position: absolute; bottom: var(--space-5); right: var(--space-5); background: linear-gradient(135deg, var(--color-orchid), #7B4BC4); border: none; color: var(--color-plumeria); padding: var(--space-3) var(--space-5); border-radius: var(--radius-md); cursor: pointer; font-family: var(--font-primary); font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; gap: var(--space-2); z-index: 50; box-shadow: 0 4px 20px rgba(155, 93, 229, 0.4); transition: all var(--duration-fast) var(--ease-natural); animation: fadeUp var(--duration-slow) var(--ease-out-expo) 0.3s both; }
        #fullscreen-btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 25px rgba(155, 93, 229, 0.5); }
        
        #error-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(230, 57, 70, 0.9); color: white; padding: var(--space-5); border-radius: var(--radius-lg); text-align: center; z-index: 200; display: none; max-width: 400px; }
        #error-message h3 { margin-bottom: var(--space-2); }
        #error-message.visible { display: block; }
        
        #coverage-status { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(244, 162, 97, 0.9); color: var(--color-lava-black); padding: var(--space-2) var(--space-4); border-radius: var(--radius-md); font-size: 0.8rem; z-index: 60; display: none; }
        #coverage-status.visible { display: block; }
        
        /* =====================================================
           WEATHER WIDGET
           ===================================================== */
        #weather-widget { position: absolute; top: var(--space-5); right: 270px; background: rgba(26, 26, 26, 0.85); backdrop-filter: blur(20px); padding: var(--space-3) var(--space-4); border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.08); z-index: 50; min-width: 160px; animation: fadeUp var(--duration-slow) var(--ease-out-expo) 0.15s both; }
        .weather-header { display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--color-seafoam); opacity: 0.7; }
        .weather-main { display: flex; align-items: center; gap: var(--space-3); }
        .weather-icon { font-size: 2rem; }
        .weather-temp { font-size: 1.5rem; font-weight: 600; font-family: var(--font-display); }
        .weather-details { font-size: 0.75rem; color: rgba(255, 255, 255, 0.6); margin-top: var(--space-2); line-height: 1.4; }
        .weather-sync-btn { background: rgba(42, 157, 143, 0.2); border: 1px solid var(--color-ti-leaf); color: var(--color-seafoam); padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); font-size: 0.65rem; cursor: pointer; margin-top: var(--space-2); transition: all var(--duration-fast); }
        .weather-sync-btn:hover { background: rgba(42, 157, 143, 0.4); }
        
        /* =====================================================
           NAVIGATION ARROWS (Street View Movement)
           ===================================================== */
        #nav-arrows { display: none; /* Hidden per user request */ }
        .nav-row { display: flex; gap: var(--space-2); }
        .nav-arrow { width: 50px; height: 50px; background: rgba(26, 26, 26, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: var(--radius-md); color: var(--color-plumeria); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all var(--duration-fast); opacity: 0.5; pointer-events: none; }
        .nav-arrow.available { opacity: 1; pointer-events: auto; }
        .nav-arrow.available:hover { background: rgba(42, 157, 143, 0.4); border-color: var(--color-ti-leaf); transform: scale(1.1); }
        .nav-arrow:active { transform: scale(0.95); }
        
        /* =====================================================
           TIME TRAVEL / HISTORICAL VIEW
           ===================================================== */
        #time-travel { position: absolute; bottom: 200px; right: var(--space-5); background: rgba(26, 26, 26, 0.85); backdrop-filter: blur(20px); padding: var(--space-3) var(--space-4); border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.08); z-index: 50; min-width: 180px; display: none; }
        #time-travel.visible { display: block; animation: fadeUp var(--duration-slow) var(--ease-out-expo); }
        .time-travel-header { display: flex; align-items: center; gap: var(--space-2); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--color-pikake); margin-bottom: var(--space-2); }
        .time-travel-year { font-size: 1.2rem; font-weight: 600; font-family: var(--font-display); text-align: center; color: var(--color-plumeria); margin-bottom: var(--space-2); }
        .time-travel-options { display: flex; flex-direction: column; gap: 6px; }
        .time-travel-option { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .time-travel-option:hover { background: rgba(255,255,255,0.1); border-color: var(--color-seafoam); }
        .time-travel-option.active { background: rgba(42,157,143,0.2); border-color: var(--color-ti-leaf); }
        .time-travel-option input[type="radio"] { accent-color: var(--color-ti-leaf); }
        .time-travel-option label { cursor: pointer; font-size: 0.85rem; color: var(--color-plumeria); flex: 1; }
        .time-travel-loading { font-size: 0.8rem; color: rgba(255,255,255,0.5); text-align: center; padding: 8px; }
        
        /* Search suggestions */
        .search-suggestion { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s; font-size: 0.85rem; }
        .search-suggestion:hover { background: rgba(42,157,143,0.2); }
        .search-suggestion:last-child { border-bottom: none; }
        .search-suggestion-name { color: var(--color-plumeria); font-weight: 500; }
        .search-suggestion-address { color: rgba(255,255,255,0.5); font-size: 0.75rem; margin-top: 2px; }
        
        /* =====================================================
           ACHIEVEMENTS & DISCOVERIES
           ===================================================== */
        #achievements-panel { display: none !important; /* Hidden per user request */ }
        .achievements-header { display: flex; align-items: center; gap: var(--space-2); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--color-gold); margin-bottom: var(--space-2); }
        .achievement-progress { display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2); }
        .achievement-icon { font-size: 1.2rem; }
        .achievement-bar { flex: 1; height: 6px; background: var(--color-volcanic-ash); border-radius: 3px; overflow: hidden; }
        .achievement-fill { height: 100%; background: linear-gradient(90deg, var(--color-gold), var(--color-pikake)); transition: width var(--duration-normal); }
        .achievement-text { font-size: 0.75rem; color: rgba(255, 255, 255, 0.8); }
        .discovery-counter { font-size: 0.8rem; color: var(--color-seafoam); margin-top: var(--space-2); padding-top: var(--space-2); border-top: 1px solid rgba(255, 255, 255, 0.08); }
        
        #treasure-found { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, rgba(255, 215, 0, 0.95), rgba(244, 162, 97, 0.95)); color: var(--color-lava-black); padding: var(--space-5) var(--space-6); border-radius: var(--radius-xl); z-index: 300; text-align: center; display: none; box-shadow: 0 0 60px rgba(255, 215, 0, 0.5); }
        #treasure-found.visible { display: block; animation: treasurePop 0.5s var(--ease-out-expo); }
        @keyframes treasurePop { from { transform: translate(-50%, -50%) scale(0); } to { transform: translate(-50%, -50%) scale(1); } }
        #treasure-found h3 { font-size: 1.5rem; margin-bottom: var(--space-2); }
        #treasure-found p { font-size: 0.9rem; opacity: 0.8; }
        
        /* =====================================================
           SOCIAL SHARING
           ===================================================== */
        #share-panel { position: absolute; bottom: 80px; right: var(--space-5); background: rgba(26, 26, 26, 0.85); backdrop-filter: blur(20px); padding: var(--space-4); border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.08); z-index: 50; min-width: 260px; display: none; }
        #share-panel.visible { display: block; animation: fadeUp var(--duration-slow) var(--ease-out-expo); }
        .share-header { display: flex; align-items: center; justify-content: space-between; gap: var(--space-2); font-size: 0.8rem; font-weight: 500; color: var(--color-seafoam); margin-bottom: var(--space-3); }
        .share-close { background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 1.2rem; }
        .share-buttons { display: flex; gap: var(--space-2); margin-bottom: var(--space-3); }
        .share-btn { flex: 1; padding: var(--space-2); border-radius: var(--radius-sm); border: none; cursor: pointer; font-size: 1.2rem; transition: transform var(--duration-fast); }
        .share-btn:hover { transform: scale(1.1); }
        .share-btn.twitter { background: #1DA1F2; }
        .share-btn.facebook { background: #4267B2; }
        .share-btn.linkedin { background: #0077B5; }
        .share-btn.copy { background: var(--color-volcanic-ash); }
        .share-url { background: var(--color-pahoehoe); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--radius-sm); padding: var(--space-2); font-size: 0.7rem; color: rgba(255, 255, 255, 0.7); word-break: break-all; margin-bottom: var(--space-2); }
        .embed-section { margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px solid rgba(255, 255, 255, 0.08); }
        .embed-code { background: var(--color-pahoehoe); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--radius-sm); padding: var(--space-2); font-size: 0.65rem; font-family: monospace; color: var(--color-seafoam); word-break: break-all; max-height: 60px; overflow-y: auto; }
        .copy-embed-btn { width: 100%; margin-top: var(--space-2); padding: var(--space-2); background: var(--color-pacific-teal); border: none; border-radius: var(--radius-sm); color: white; font-size: 0.75rem; cursor: pointer; transition: background var(--duration-fast); }
        .copy-embed-btn:hover { background: var(--color-ti-leaf); }
        
        /* =====================================================
           PERFORMANCE DASHBOARD
           ===================================================== */
        #perf-dashboard { position: absolute; bottom: var(--space-5); left: 220px; background: rgba(26, 26, 26, 0.7); backdrop-filter: blur(10px); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.08); z-index: 50; font-family: 'Courier New', monospace; font-size: 0.7rem; display: none; }
        #perf-dashboard.visible { display: block; animation: fadeUp var(--duration-slow) var(--ease-out-expo); }
        .perf-row { display: flex; gap: var(--space-3); align-items: center; margin-bottom: var(--space-1); }
        .perf-row:last-child { margin-bottom: 0; }
        .perf-label { color: var(--color-cinder); min-width: 50px; }
        .perf-value { color: var(--color-ti-leaf); font-weight: 600; }
        .perf-value.warning { color: var(--color-pikake); }
        .perf-value.danger { color: var(--color-hibiscus); }
        .perf-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--color-ti-leaf); }
        .perf-indicator.loading { background: var(--color-pikake); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        /* =====================================================
           RESPONSIVE
           ===================================================== */
        @media (max-width: 768px) {
            #info { top: auto; bottom: 160px; left: var(--space-4); right: var(--space-4); max-width: none; }
            #location-selector { top: var(--space-4); width: calc(100% - 32px); }
            #location-dropdown { width: 100%; min-width: auto; }
            #mini-map-container { display: none; }
            #weather-widget { top: auto; bottom: 260px; right: var(--space-4); left: var(--space-4); }
            #achievements-panel { top: auto; bottom: 320px; left: var(--space-4); right: var(--space-4); }
            #effects { position: fixed; top: auto; bottom: 0; left: 0; right: 0; border-radius: var(--radius-lg) var(--radius-lg) 0 0; transform: translateY(100%); transition: transform var(--duration-normal) var(--ease-out-expo); max-height: 70vh; overflow-y: auto; }
            #effects.open { transform: translateY(0); }
            #controls { bottom: var(--space-4); }
            .control-btn { padding: var(--space-3) var(--space-4); }
            #hints { bottom: 80px; font-size: 0.7rem; }
            #fullscreen-btn { bottom: auto; top: var(--space-4); right: var(--space-4); }
            #loading h1 { font-size: 2rem; }
            .loading-subtitle { font-size: 1rem; padding: 0 var(--space-4); }
            .loading-tip { font-size: 0.8rem; padding: 0 var(--space-4); }
            #nav-arrows { bottom: 100px; }
            .nav-arrow { width: 40px; height: 40px; font-size: 1.2rem; }
            #perf-dashboard { left: var(--space-4); bottom: 140px; }
            .time-selector { flex-wrap: wrap; }
            .time-btn { min-width: 50px; padding: var(--space-2); }
            #screenshot-watermark, #screenshot-stamp { font-size: 0.7rem; padding: 6px 10px; }
        }
        
        @media (max-width: 480px) {
            #loading h1 { font-size: 1.75rem; }
            .loading-logo { font-size: 3.5rem; }
            .loading-progress { width: 260px; }
        }
        
        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; } }
        *:focus-visible { outline: 2px solid var(--color-shallow-water); outline-offset: 2px; }
        .gm-style-cc, .gmnoprint { display: none !important; }
    </style>
</head>
<body>
    <div id="viewer">
        <div id="loading">
            <div class="loading-stars"></div>
            <div class="loading-logo">üå¥</div>
            <h1>Big Island VR</h1>
            <p class="loading-subtitle">"E komo mai" ‚Äî Welcome to Hawai ªi</p>
            <div class="loading-progress"><div class="loading-progress-bar"></div></div>
            <p class="loading-tip" id="loading-tip">üí° Use arrow keys to navigate between locations</p>
            <p class="loading-location">Loading <span id="loading-location-name">Street View</span>...</p>
        </div>
        
        <div id="transition-overlay"></div>
        <div id="color-grade"></div>
        <div id="bloom-layer"></div>
        <div id="atmosphere-layer" class="time-day"></div>
        <div id="vignette-layer" class="active"></div>
        <div id="lens-flare">
            <div class="flare-main" style="top: 15%; left: 70%;"></div>
            <div class="flare-secondary" style="top: 25%; left: 60%;"></div>
            <div class="flare-streak" style="top: 20%; left: 65%; transform: rotate(-15deg);"></div>
            <div class="flare-hexagon" style="top: 35%; left: 45%;"></div>
            <div class="flare-hexagon" style="top: 40%; left: 35%; width: 20px; height: 20px;"></div>
        </div>
        <div id="mist-layer"></div>
        <div id="street-view-container"></div>
        <canvas id="shader-animation-canvas"></canvas>
        <canvas id="rain-canvas"></canvas>
        <canvas id="particles-canvas"></canvas>
        <div id="fireflies-container"></div>
        <div id="butterflies-container"></div>
        <div id="leaves-container"></div>
        <div id="ash-container"></div>
        <div id="spray-container"></div>
        <div id="screenshot-flash"></div>
        <div id="screenshot-watermark">üå¥ Big Island VR</div>
        <div id="screenshot-stamp"></div>
        
        <div id="error-message"><h3>üìç No Street View Here</h3><p>Trying nearby location...</p></div>
        <div id="coverage-status">‚ö†Ô∏è Limited coverage - showing nearest available view</div>
        <button id="audio-unlock"><span>üîä</span><span>Click to Enable Audio</span></button>
        
        <div id="location-selector">
            <!-- Dropdown hidden, search bar only -->
            <select id="location-dropdown" aria-label="Select location" style="display: none;">
                <option value="" disabled>üó∫Ô∏è Choose a destination...</option>
            </select>
            <div style="position: relative;">
                <input type="text" id="destination-search" placeholder="üîç Search any place on the Big Island..." 
                    style="background: rgba(26, 26, 26, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: var(--radius-lg); color: var(--color-plumeria); padding: var(--space-4) var(--space-5); font-family: var(--font-primary); font-size: 1rem; width: 350px; text-align: center; transition: all 0.2s; box-shadow: 0 4px 20px rgba(0,0,0,0.3);"
                    autocomplete="off">
                <div id="search-suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: rgba(26, 26, 26, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: var(--radius-md); margin-top: 4px; max-height: 300px; overflow-y: auto; display: none; z-index: 100;"></div>
            </div>
        </div>
        
        <!-- Weather Widget -->
        <div id="weather-widget">
            <div class="weather-header">üå§Ô∏è Big Island Weather</div>
            <div class="weather-main">
                <span class="weather-icon" id="weather-icon">‚òÄÔ∏è</span>
                <span class="weather-temp" id="weather-temp">--¬∞F</span>
            </div>
            <div class="weather-details" id="weather-details">Loading weather...</div>
            <button class="weather-sync-btn" id="weather-sync-btn">üîÑ Sync Ambient Effects</button>
        </div>
        
        <div id="info">
            <div class="info-brand"><span>üå¥</span><span>Big Island VR</span></div>
            <h2 id="location-name">Loading...</h2>
            <p id="location-desc">Real 360¬∞ Street View from Hawai ªi</p>
            <p id="location-summary" style="font-size: 0.8rem; color: rgba(255,255,255,0.7); line-height: 1.4; margin: 8px 0; padding: 8px; background: rgba(42,157,143,0.1); border-radius: 8px; border-left: 3px solid var(--color-ti-leaf); display: none;"></p>
            <div class="location-dots" id="location-dots"></div>
            <div id="location-counter">Location 1 of 15</div>
        </div>
        
        <!-- Achievements Panel (hidden) -->
        <div id="achievements-panel" style="display: none;">
            <div class="achievements-header">üèÜ Achievements</div>
            <div class="achievement-progress">
                <span class="achievement-icon">üìç</span>
                <div class="achievement-bar"><div class="achievement-fill" id="locations-fill" style="width: 0%"></div></div>
            </div>
            <div class="achievement-text" id="locations-progress">Visited: 0/15 locations</div>
            <div class="achievement-progress">
                <span class="achievement-icon">üèùÔ∏è</span>
                <div class="achievement-bar"><div class="achievement-fill" id="regions-fill" style="width: 0%"></div></div>
            </div>
            <div class="achievement-text" id="regions-progress">Regions: 0/7 explored</div>
            <div class="discovery-counter">
                <span>üíé Treasures Found: </span><span id="treasures-found">0</span><span>/8</span>
            </div>
        </div>
        
        <div id="mini-map-container">
            <div id="mini-map"></div>
            <div class="mini-map-label">Click to teleport</div>
        </div>
        
        <div id="effects">
            <div class="effects-header" id="effects-header" style="cursor: pointer; user-select: none;">
                <span>üéõÔ∏è</span><span>Effects</span>
                <span id="effects-toggle" style="margin-left: auto; font-size: 0.8rem; opacity: 0.6;">‚ñ∂</span>
            </div>
            <div id="effects-content" style="display: none;">
            
            <!-- AUDIO SECTION -->
            <div class="effects-section">
                <div class="section-title">üîä Audio</div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">üåä</span><span>Ocean Waves</span></span><div class="toggle-switch on" data-effect="ocean" role="switch" aria-checked="true" tabindex="0"></div></div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">üê¶</span><span>Birdsong</span></span><div class="toggle-switch on" data-effect="birds" role="switch" aria-checked="true" tabindex="0"></div></div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">üí®</span><span>Wind</span></span><div class="toggle-switch" data-effect="wind" role="switch" aria-checked="false" tabindex="0"></div></div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">üåßÔ∏è</span><span>Rain</span></span><div class="toggle-switch" data-effect="rain-audio" role="switch" aria-checked="false" tabindex="0"></div></div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">üåã</span><span>Volcanic Rumble</span></span><div class="toggle-switch" data-effect="volcanic" role="switch" aria-checked="false" tabindex="0"></div></div>
            </div>
            
            <!-- VISUAL: WEATHER OVERLAY -->
            <div class="effects-section">
                <div class="section-title">üå¶Ô∏è Weather Overlay</div>
                <div class="slider-row">
                    <div class="slider-label"><span>üåßÔ∏è Rain</span><span class="slider-value" id="rain-value">0%</span></div>
                    <input type="range" class="effect-slider" id="rain-slider" min="0" max="100" value="0" aria-label="Rain intensity">
                </div>
                <div class="slider-row">
                    <div class="slider-label"><span>üí® Wind Strength</span><span class="slider-value" id="wind-value">20%</span></div>
                    <input type="range" class="effect-slider" id="wind-slider" min="0" max="100" value="20" aria-label="Wind strength">
                </div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">üå´Ô∏è</span><span>Mist/Fog</span></span><div class="toggle-switch" data-effect="mist" role="switch" aria-checked="false" tabindex="0"></div></div>
            </div>
            
            <!-- VISUAL: TIME OF DAY -->
            <div class="effects-section">
                <div class="section-title">‚òÄÔ∏è Time of Day <span style="opacity:0.5;font-size:0.6rem">(color overlay)</span></div>
                <div class="time-selector">
                    <button class="time-btn" data-time="dawn" aria-label="Dawn"><span class="time-btn-icon">üåÖ</span>Dawn</button>
                    <button class="time-btn active" data-time="day" aria-label="Day"><span class="time-btn-icon">‚òÄÔ∏è</span>Day</button>
                    <button class="time-btn" data-time="golden" aria-label="Golden Hour"><span class="time-btn-icon">üåá</span>Golden</button>
                    <button class="time-btn" data-time="dusk" aria-label="Dusk"><span class="time-btn-icon">üåÜ</span>Dusk</button>
                    <button class="time-btn" data-time="night" aria-label="Night"><span class="time-btn-icon">üåô</span>Night</button>
                </div>
                <div class="ai-coming-soon" style="margin-top:8px;padding:6px 8px;background:linear-gradient(90deg,rgba(155,93,229,0.15),rgba(61,165,217,0.15));border-radius:6px;font-size:0.7rem;color:var(--color-orchid);display:flex;align-items:center;gap:6px;">
                    <span>ü§ñ</span><span>AI Time Transform coming soon ‚Äî actual image transformation, not just overlays</span>
                </div>
            </div>
            
            <!-- VISUAL: POST-PROCESSING -->
            <div class="effects-section">
                <div class="section-title">‚ú® Visual Post-Processing</div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">üîÜ</span><span>Vignette</span></span><div class="toggle-switch" data-effect="vignette" role="switch" aria-checked="false" tabindex="0"></div></div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">üí´</span><span>Bloom</span></span><div class="toggle-switch" data-effect="bloom" role="switch" aria-checked="false" tabindex="0"></div></div>
            </div>
            
            <!-- VISUAL: PARTICLES (hidden for now) -->
            <div class="effects-section" style="display: none;">
                <div class="section-title">ü¶ã Animated Particles</div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">ü¶ã</span><span>Butterflies</span></span><div class="toggle-switch" data-effect="butterflies" role="switch" aria-checked="false" tabindex="0"></div></div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">‚ú®</span><span>Fireflies</span></span><div class="toggle-switch" data-effect="fireflies" role="switch" aria-checked="false" tabindex="0"></div></div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">üçÇ</span><span>Falling Leaves</span></span><div class="toggle-switch" data-effect="leaves" role="switch" aria-checked="false" tabindex="0"></div></div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">üåã</span><span>Volcanic Ash</span></span><div class="toggle-switch" data-effect="ash" role="switch" aria-checked="false" tabindex="0"></div></div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">üåä</span><span>Ocean Spray</span></span><div class="toggle-switch" data-effect="spray" role="switch" aria-checked="false" tabindex="0"></div></div>
            </div>
            
            <!-- VISUAL: SCENE ANIMATION -->
            <div class="effects-section">
                <div class="section-title">üé¨ Scene Animation</div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">‚ú®</span><span>Enable Animation</span></span><div class="toggle-switch" data-effect="scene-animation" role="switch" aria-checked="false" tabindex="0"></div></div>
                <div class="slider-row" id="scene-anim-sliders" style="opacity: 0.5; pointer-events: none;">
                    <div class="slider-label"><span>‚òÅÔ∏è Cloud Drift</span><span class="slider-value" id="cloud-drift-value">100%</span></div>
                    <input type="range" class="effect-slider" id="cloud-drift-slider" min="0" max="100" value="100" aria-label="Cloud drift intensity">
                </div>
                <div class="slider-row" id="water-ripple-row" style="opacity: 0.5; pointer-events: none;">
                    <div class="slider-label"><span>üåä Water Ripples</span><span class="slider-value" id="water-ripple-value">50%</span></div>
                    <input type="range" class="effect-slider" id="water-ripple-slider" min="0" max="100" value="50" aria-label="Water ripple intensity">
                </div>
                <div class="slider-row" id="veg-sway-row" style="opacity: 0.5; pointer-events: none;">
                    <div class="slider-label"><span>üåø Vegetation Sway</span><span class="slider-value" id="veg-sway-value">30%</span></div>
                    <input type="range" class="effect-slider" id="veg-sway-slider" min="0" max="100" value="30" aria-label="Vegetation sway intensity">
                </div>
                <div class="scene-anim-status" id="scene-anim-status" style="margin-top:8px;padding:6px 8px;background:rgba(42,157,143,0.1);border-radius:6px;font-size:0.7rem;color:var(--color-seafoam);display:none;">
                    <span id="scene-anim-status-text">Loading masks...</span>
                </div>
            </div>
            
            <div class="effects-section">
                <div class="section-title">üì∏ Screenshot</div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">üè∑Ô∏è</span><span>Watermark</span></span><div class="toggle-switch" data-effect="watermark" role="switch" aria-checked="false" tabindex="0"></div></div>
                <div class="effect-row"><span class="effect-label"><span class="effect-icon">üìç</span><span>Location Stamp</span></span><div class="toggle-switch" data-effect="stamp" role="switch" aria-checked="false" tabindex="0"></div></div>
                <button id="take-screenshot-btn" class="screenshot-btn">
                    <span>üì∑</span><span>Take Screenshot</span>
                </button>
            </div>
            
            <div class="volume-section">
                <div class="volume-label"><span>üîä Master Volume</span><span id="volume-value">80%</span></div>
                <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="80" aria-label="Master volume">
            </div>
            </div><!-- end effects-content -->
        </div>
        
        <!-- Navigation Arrows for Street View Movement -->
        <div id="nav-arrows">
            <div class="nav-row">
                <button class="nav-arrow" id="nav-forward" aria-label="Move forward">‚Üë</button>
            </div>
            <div class="nav-row">
                <button class="nav-arrow" id="nav-left" aria-label="Turn left">‚Üê</button>
                <button class="nav-arrow" id="nav-backward" aria-label="Move backward">‚Üì</button>
                <button class="nav-arrow" id="nav-right" aria-label="Turn right">‚Üí</button>
            </div>
        </div>
        
        <!-- Time Travel Panel -->
        <div id="time-travel">
            <div class="time-travel-header">‚è≥ Time Travel</div>
            <div class="time-travel-year" id="time-travel-year">Current</div>
            <div id="time-travel-options" class="time-travel-options">
                <!-- Populated dynamically based on available years -->
                <div class="time-travel-loading">Checking history...</div>
            </div>
        </div>
        
        <!-- Share Panel -->
        <div id="share-panel">
            <div class="share-header">
                <span>üîó Share This View</span>
                <button class="share-close" id="share-close">√ó</button>
            </div>
            <div class="share-buttons">
                <button class="share-btn twitter" id="share-twitter" aria-label="Share on Twitter">ùïè</button>
                <button class="share-btn facebook" id="share-facebook" aria-label="Share on Facebook">f</button>
                <button class="share-btn linkedin" id="share-linkedin" aria-label="Share on LinkedIn">in</button>
                <button class="share-btn copy" id="share-copy" aria-label="Copy link">üìã</button>
            </div>
            <div class="share-url" id="share-url">https://...</div>
            <div class="embed-section">
                <div class="section-title">üì¶ Embed Code</div>
                <div class="embed-code" id="embed-code">&lt;iframe src="..." width="800" height="600"&gt;&lt;/iframe&gt;</div>
                <button class="copy-embed-btn" id="copy-embed">Copy Embed Code</button>
            </div>
        </div>
        
        <!-- Performance Dashboard -->
        <div id="perf-dashboard">
            <div class="perf-row">
                <span class="perf-label">FPS:</span>
                <span class="perf-value" id="perf-fps">60</span>
            </div>
            <div class="perf-row">
                <span class="perf-label">MEM:</span>
                <span class="perf-value" id="perf-mem">-- MB</span>
            </div>
            <div class="perf-row">
                <span class="perf-label">NET:</span>
                <span class="perf-indicator" id="perf-net-indicator"></span>
                <span class="perf-value" id="perf-net">Ready</span>
            </div>
        </div>
        
        <!-- Treasure Found Popup -->
        <div id="treasure-found">
            <h3>üéâ Treasure Found!</h3>
            <p id="treasure-message">You discovered a hidden gem!</p>
        </div>
        
        <div id="controls">
            <button class="control-btn" id="prev-btn" aria-label="Previous location"><span>‚¨ÖÔ∏è</span><span>Previous</span></button>
            <button class="control-btn" id="play-btn" aria-label="Toggle auto-play"><span id="play-icon">‚ñ∂Ô∏è</span><span id="play-text">Auto Tour</span></button>
            <button class="control-btn" id="next-btn" aria-label="Next location"><span>Next</span><span>‚û°Ô∏è</span></button>
            <button class="control-btn" id="share-btn" aria-label="Share"><span>üîó</span><span>Share</span></button>
            <button class="control-btn" id="perf-btn" aria-label="Performance"><span>üìä</span></button>
        </div>
        
        <button id="fullscreen-btn" aria-label="Toggle fullscreen"><span>‚õ∂</span><span>Fullscreen</span></button>
        
        <div id="hints"><kbd>‚Üê</kbd> <kbd>‚Üí</kbd> Navigate ¬∑ <kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> Move ¬∑ <kbd>Space</kbd> Auto-tour ¬∑ <kbd>P</kbd> Perf</div>
    </div>
    
    <script>
        const VERSION = '3.1.0';
        const API_KEY = 'AIzaSyBmSDHrsQunVjxhZ4UHQ0asdUY6vZVFszY';
        const CONFIG = { transitionDuration: 800, autoPlayInterval: 12000, searchRadius: 500, audioCrossfadeDuration: 2000 };
        
        // CC0/Free Audio Sources from freesound.org
        const AUDIO_URLS = {
            ocean: 'https://cdn.freesound.org/previews/531/531015_6746984-lq.mp3',
            birds: 'https://cdn.freesound.org/previews/352/352515_4164823-lq.mp3',
            wind: 'https://cdn.freesound.org/previews/217/217506_2493965-lq.mp3',
            rain: 'https://cdn.freesound.org/previews/104/104390_866265-lq.mp3',
            waterfall: 'https://cdn.freesound.org/previews/365/365915_6142149-lq.mp3',
            volcanic: 'https://cdn.freesound.org/previews/198/198879_1616430-lq.mp3'
        };
        
        const LOCATIONS = [
            // HILO REGION (5 locations)
            { id: 1, name: "Hilo Bayfront", desc: "Lili ªuokalani Park looking toward Coconut Island (Moku Ola)", region: "Hilo", lat: 19.7235, lng: -155.0720, heading: 45, pitch: 0, audio: { ocean: 0.8, birds: 0.5, wind: 0.2 }, atmosphere: { mist: false, volcanic: false }, summary: "üèùÔ∏è Coconut Island (Moku Ola) was once a place of healing in ancient Hawaii. Queen Lili ªuokalani dedicated this park in 1917, featuring Japanese gardens that honor the 1960 tsunami victims." },
            { id: 2, name: "Banyan Drive", desc: "Historic avenue lined with banyan trees planted by celebrities", region: "Hilo", lat: 19.7235, lng: -155.0772, heading: 180, pitch: 0, audio: { ocean: 0.4, birds: 0.8, wind: 0.1 }, atmosphere: { mist: false, volcanic: false }, summary: "üå≥ Each banyan tree was planted by a celebrity in the 1930s-1970s, including Babe Ruth, Amelia Earhart, and Franklin D. Roosevelt. The trees create a natural canopy over this historic shoreline drive." },
            { id: 3, name: "Rainbow Falls Viewpoint", desc: "WaiƒÅnuenue ‚Äî iconic 80-foot waterfall just outside Hilo", region: "Hilo", lat: 19.7189, lng: -155.1065, heading: 270, pitch: -10, audio: { waterfall: 0.8, birds: 0.6, wind: 0.2 }, atmosphere: { mist: true, volcanic: false }, treasure: { id: 'rainbow', name: 'Rainbow Spirit', message: 'You found the spirit of WaiƒÅnuenue! üåà' }, summary: "üåà Named 'WaiƒÅnuenue' (rainbow water), morning sunlight creates rainbows in the mist. Legend says the cave behind the falls is home to Hina, goddess of the moon and mother of Maui." },
            { id: 4, name: "Hilo Farmers Market", desc: "Vibrant outdoor market in downtown Hilo", region: "Hilo", lat: 19.7244, lng: -155.0896, heading: 90, pitch: 0, audio: { birds: 0.3, wind: 0.1 }, atmosphere: { mist: false, volcanic: false }, summary: "ü•≠ Operating since 1988, this market features 200+ local vendors selling tropical fruits, flowers, crafts, and fresh poke. It's the largest open-air market in Hawaii!" },
            { id: 5, name: "Pepe ªekeo Scenic Drive", desc: "Lush 4-mile coastal road through tropical rainforest", region: "Hilo", lat: 19.8345, lng: -155.1012, heading: 45, pitch: 0, audio: { birds: 0.9, wind: 0.3 }, atmosphere: { mist: true, volcanic: false }, summary: "üåø This old highway winds through dense tropical jungle past one-lane bridges and small waterfalls. Once the main coastal route, it's now a peaceful detour showcasing Hawaii's rainforest beauty." },
            
            // HAMAKUA COAST (4 locations)
            { id: 6, name: "Akaka Falls State Park", desc: "Spectacular 442-foot waterfall in lush rainforest", region: "Hamakua", lat: 19.8535, lng: -155.1527, heading: 90, pitch: -5, audio: { waterfall: 0.9, birds: 0.7, wind: 0.2 }, atmosphere: { mist: true, volcanic: false }, treasure: { id: 'akaka', name: 'Akaka Spirit', message: 'You discovered the majestic Akaka Falls! üíß' }, summary: "üíß At 442 feet, Akaka Falls plunges into a gorge surrounded by wild orchids, bamboo, and ferns. The name 'Akaka' means to crack or split, describing how the water breaks on the rocks below." },
            { id: 7, name: "Waipi ªo Valley Lookout", desc: "Breathtaking viewpoint of the Valley of the Kings", region: "Hamakua", lat: 20.1177, lng: -155.5868, heading: 315, pitch: -10, audio: { wind: 0.6, birds: 0.5, ocean: 0.2 }, atmosphere: { mist: false, volcanic: false }, summary: "üëë This sacred 'Valley of the Kings' was home to Hawaiian royalty. Once populated by 10,000+ people, it features a black sand beach and 1,300-foot cliffs. King Kamehameha spent his childhood here." },
            { id: 8, name: "Honoka ªa Town", desc: "Historic sugar plantation town with vintage charm", region: "Hamakua", lat: 20.0787, lng: -155.4678, heading: 0, pitch: 0, audio: { birds: 0.4, wind: 0.2 }, atmosphere: { mist: false, volcanic: false }, summary: "üèöÔ∏è This 1880s sugar town has reinvented itself with antique shops, art galleries, and local eateries. The Honoka'a People's Theatre (1930) still shows films today." },
            { id: 9, name: "LaupƒÅhoehoe Point", desc: "Dramatic coastline with powerful wave action", region: "Hamakua", lat: 19.9907, lng: -155.2384, heading: 45, pitch: 0, audio: { ocean: 0.9, wind: 0.6 }, atmosphere: { mist: true, volcanic: false }, summary: "üåä This lava peninsula was tragically struck by the 1946 tsunami, taking 24 lives including students and teachers. A memorial honors them today. The name means 'leaf of smooth lava.'" },
            
            // PUNA REGION (2 locations)
            { id: 10, name: "Kea ªau Town Center", desc: "Small town gateway to the Puna district", region: "Puna", lat: 19.6222, lng: -155.0386, heading: 0, pitch: 0, audio: { birds: 0.6, wind: 0.2 }, atmosphere: { mist: false, volcanic: false }, summary: "üå∫ Gateway to the wild Puna district, Kea ªau sits at the edge of tropical farmland and ohia forests. The area is known for papaya farms and an independent, off-grid community spirit." },
            { id: 11, name: "PƒÅhoa Village", desc: "Funky town with historic wooden boardwalk", region: "Puna", lat: 19.4959, lng: -154.9437, heading: 180, pitch: 0, audio: { birds: 0.5, wind: 0.2 }, atmosphere: { mist: false, volcanic: false }, summary: "üé® This bohemian village features an 1890s wooden boardwalk, eclectic shops, and resilient locals who survived the 2018 lava flows. The 'Wild West of Hawaii' keeps its counterculture vibe alive." },
            
            // VOLCANO REGION (5 locations)
            { id: 12, name: "Volcano Village", desc: "Misty rainforest village near Kƒ´lauea", region: "Volcano", lat: 19.4329, lng: -155.2339, heading: 90, pitch: 0, audio: { birds: 0.7, wind: 0.4, rain: 0.3 }, atmosphere: { mist: true, volcanic: false }, defaultRain: 20, summary: "üåßÔ∏è At 4,000 feet elevation, this misty village gets 140 inches of rain yearly. Artists and dreamers flock here for the cool climate and proximity to Kƒ´lauea's power." },
            { id: 13, name: "Kƒ´lauea Visitor Center", desc: "Gateway to Hawai ªi Volcanoes National Park", region: "Volcano", lat: 19.4313, lng: -155.2570, heading: 180, pitch: 0, audio: { wind: 0.6, volcanic: 0.5 }, atmosphere: { mist: true, volcanic: true }, treasure: { id: 'pele', name: 'Pele\'s Blessing', message: 'You received Pele\'s blessing at the sacred volcano! üåã' }, summary: "üåã Hawai ªi Volcanoes National Park is home to Kƒ´lauea, one of Earth's most active volcanoes. Pele, the fire goddess, is said to live in Halema ªuma ªu crater. The park became a UNESCO World Heritage Site in 1987." },
            { id: 14, name: "Kƒ´lauea Crater Rim", desc: "Dramatic views of the active Halema ªuma ªu crater", region: "Volcano", lat: 19.4119, lng: -155.2833, heading: 220, pitch: 0, audio: { wind: 0.8, volcanic: 0.7 }, atmosphere: { mist: true, volcanic: true }, summary: "üî• Halema ªuma ªu crater is the legendary home of Pele. The 2018 eruption dramatically changed this landscape, collapsing the crater floor and creating a new water lake‚Äîthe first in recorded history." },
            { id: 15, name: "Chain of Craters Road", desc: "Scenic drive through lava fields to the coast", region: "Volcano", lat: 19.3053, lng: -155.1014, heading: 180, pitch: 0, audio: { wind: 0.7, ocean: 0.3, volcanic: 0.2 }, atmosphere: { mist: false, volcanic: true }, summary: "üõ£Ô∏è This 19-mile road descends 3,700 feet through multiple lava flows from 1969-1974. It ends abruptly where 2003 lava covered the old coastal highway, a powerful reminder of the land's constant transformation." },
            { id: 16, name: "Thurston Lava Tube", desc: "Walk through a 500-year-old lava tube (NƒÅhuku)", region: "Volcano", lat: 19.4145, lng: -155.2391, heading: 90, pitch: 0, audio: { birds: 0.8, wind: 0.1 }, atmosphere: { mist: true, volcanic: false }, summary: "üï≥Ô∏è NƒÅhuku ('the protuberances') formed when the outer crust of a lava flow hardened while molten rock continued flowing inside. This 500-year-old tube is surrounded by native '≈çhi'a forest full of birdsong." },
            
            // KA ª≈™ DISTRICT (3 locations)
            { id: 17, name: "Punalu'u Black Sand Beach", desc: "Famous black sand beach where sea turtles rest", region: "Ka ª≈´", lat: 19.1361, lng: -155.5044, heading: 180, pitch: 0, audio: { ocean: 0.9, wind: 0.4 }, atmosphere: { mist: false, volcanic: false }, treasure: { id: 'honu', name: 'Honu Blessing', message: 'You witnessed the sacred sea turtles (honu)! üê¢' }, summary: "üê¢ This jet-black beach was created when hot lava shattered as it hit the ocean. Green sea turtles (honu) bask here daily‚Äîthey're protected, so keep your distance! Ancient heiau ruins dot the shoreline." },
            { id: 18, name: "South Point (Ka Lae)", desc: "Southernmost point in the United States", region: "Ka ª≈´", lat: 18.9108, lng: -155.6817, heading: 180, pitch: 0, audio: { wind: 1.0, ocean: 0.6 }, atmosphere: { mist: false, volcanic: false }, summary: "üß≠ Ka Lae is where Polynesian voyagers first landed in Hawaii around 400 AD. At 18.9¬∞ latitude, it's the southernmost point in the USA. The constant 30mph winds powered the rusty windmills you see today." },
            { id: 19, name: "NƒÅ ªƒÅlehu Town", desc: "Southernmost town in the USA with local charm", region: "Ka ª≈´", lat: 19.0625, lng: -155.5786, heading: 90, pitch: 0, audio: { birds: 0.3, wind: 0.2 }, atmosphere: { mist: false, volcanic: false }, summary: "üá∫üá∏ America's southernmost town sits in the heart of Ka ª≈´ ranch country. The historic Punalu'u Bake Shop here is famous for its sweetbread, and Mark Twain once planted a monkey pod tree in town (it fell in 1957)." },
            
            // KONA COAST (6 locations)
            { id: 20, name: "Ali ªi Drive, Kailua-Kona", desc: "Historic oceanfront street in downtown Kona", region: "Kona", lat: 19.6400, lng: -155.9969, heading: 270, pitch: 0, audio: { ocean: 0.9, birds: 0.3, wind: 0.2 }, atmosphere: { mist: false, volcanic: false }, treasure: { id: 'sunset', name: 'Golden Sunset', message: 'You captured the legendary Kona sunset! üåÖ' }, summary: "üåÖ Named after the ali'i (royalty), this waterfront strip was where Hawaiian chiefs lived. The Ironman World Championship starts and ends here. Kona's dry climate creates legendary sunsets." },
            { id: 21, name: "Kailua Pier", desc: "Heart of Kona ‚Äî departure point for ocean adventures", region: "Kona", lat: 19.6392, lng: -155.9987, heading: 270, pitch: 0, audio: { ocean: 1.0, wind: 0.3 }, atmosphere: { mist: false, volcanic: false }, summary: "‚öì This historic pier has hosted the Ironman World Championship since 1981. Fishermen once hauled in 1,000+ pound marlin here. Watch for spinner dolphins and outrigger canoe paddlers at dawn." },
            { id: 22, name: "Keauhou Bay", desc: "Beautiful bay south of Kona, great for snorkeling", region: "Kona", lat: 19.5611, lng: -155.9647, heading: 270, pitch: 0, audio: { ocean: 0.8, birds: 0.2, wind: 0.2 }, atmosphere: { mist: false, volcanic: false }, summary: "üëë Kamehameha III was born here in 1814, seemingly stillborn but revived by a visiting kahuna. A small beach and calm waters make this a favorite for manta ray night snorkeling." },
            { id: 23, name: "Kealakekua Bay", desc: "Marine sanctuary and Captain Cook monument", region: "Kona", lat: 19.4766, lng: -155.9311, heading: 270, pitch: 0, audio: { ocean: 0.8, birds: 0.4, wind: 0.2 }, atmosphere: { mist: false, volcanic: false }, summary: "‚õµ Captain Cook landed here in 1779 and was killed in a skirmish weeks later. The white monument marks the spot. This marine sanctuary has some of Hawaii's clearest water and best snorkeling." },
            { id: 24, name: "Pu ªuhonua o H≈çnaunau", desc: "Place of Refuge ‚Äî sacred Hawaiian sanctuary", region: "Kona", lat: 19.4226, lng: -155.9104, heading: 270, pitch: 0, audio: { ocean: 0.7, wind: 0.3 }, atmosphere: { mist: false, volcanic: false }, treasure: { id: 'refuge', name: 'Sacred Refuge', message: 'You found peace at the Place of Refuge! üôè' }, summary: "üôè In ancient Hawaii, breaking kapu (sacred laws) meant death‚Äîunless you reached this sanctuary. Absolved by priests, you could start anew. The massive 1,000-foot wall still stands after 400 years." },
            { id: 25, name: "Hapuna Beach", desc: "Award-winning white sand beach on Kohala coast", region: "Kona", lat: 19.9881, lng: -155.8278, heading: 270, pitch: 0, audio: { ocean: 0.9, wind: 0.3 }, atmosphere: { mist: false, volcanic: false }, summary: "üèñÔ∏è Consistently ranked among America's best beaches, Hapuna's half-mile of white sand and turquoise water is postcard-perfect. Strong currents make swimming adventurous‚Äîrespect the ocean!" },
            
            // KOHALA COAST (5 locations)
            { id: 26, name: "Mauna Lani Resort", desc: "Luxury resort area with ancient fishponds", region: "Kohala", lat: 19.9347, lng: -155.8589, heading: 270, pitch: 0, audio: { ocean: 0.6, birds: 0.4, wind: 0.2 }, atmosphere: { mist: false, volcanic: false }, summary: "üêü Ancient Hawaiians built fishponds here to raise fish for royalty. The lava tubes and caves hold significant petroglyphs. Today it's a world-class resort where history meets luxury." },
            { id: 27, name: "Waikoloa Village", desc: "Resort community with petroglyph fields nearby", region: "Kohala", lat: 19.9183, lng: -155.7878, heading: 180, pitch: 0, audio: { wind: 0.3, birds: 0.2 }, atmosphere: { mist: false, volcanic: false }, summary: "üñºÔ∏è The nearby Puak≈ç Petroglyph Archaeological Preserve has 3,000+ ancient carvings‚Äîone of Hawaii's largest collections. Kings once traveled this trail, leaving their stories in stone." },
            { id: 28, name: "HƒÅwƒ´ Town", desc: "Charming art galleries in North Kohala", region: "Kohala", lat: 20.2411, lng: -155.8339, heading: 180, pitch: 0, audio: { birds: 0.4, wind: 0.5 }, atmosphere: { mist: false, volcanic: false }, summary: "üé® This artsy plantation town at road's end was nearly abandoned when sugar died. Artists revived it with galleries, cafes, and the famous Bamboo Restaurant. Kohala Mountain provides a stunning backdrop." },
            { id: 29, name: "Polol≈´ Valley Lookout", desc: "Dramatic views of remote valley and black sand beach", region: "Kohala", lat: 20.2048, lng: -155.7328, heading: 0, pitch: -10, audio: { wind: 0.7, ocean: 0.4, birds: 0.3 }, atmosphere: { mist: true, volcanic: false }, summary: "üèûÔ∏è This is where the road ends and wilderness begins. A steep 20-minute trail descends to a black sand beach and wild valley‚Äîthe first of seven valleys carved by ancient streams. Bring sturdy shoes!" },
            { id: 30, name: "Kapa ªau Town", desc: "Home of the original King Kamehameha statue", region: "Kohala", lat: 20.2333, lng: -155.8000, heading: 90, pitch: 0, audio: { birds: 0.3, wind: 0.3 }, atmosphere: { mist: false, volcanic: false }, treasure: { id: 'kamehameha', name: 'Royal Legacy', message: 'You honored King Kamehameha! üëë' }, summary: "üëë The ORIGINAL Kamehameha statue stands here near his birthplace. Lost at sea, recovered from the ocean floor, it was placed here after a replica took its spot in Honolulu. Lei offerings honor him daily." },
            
            // WAIMEA & SADDLE (3 locations)
            { id: 31, name: "Waimea Town Center", desc: "Paniolo (Hawaiian cowboy) country in the highlands", region: "Waimea", lat: 20.0234, lng: -155.6659, heading: 0, pitch: 0, audio: { wind: 0.5, birds: 0.5 }, atmosphere: { mist: false, volcanic: false }, treasure: { id: 'paniolo', name: 'Paniolo Spirit', message: 'You discovered the spirit of the Hawaiian cowboys! ü§†' }, summary: "ü§† Hawaiian cowboy culture started here in 1793 when cattle from Vancouver ran wild. Mexican vaqueros came in 1832 to teach ranching. Parker Ranch became one of America's largest cattle ranches." },
            { id: 32, name: "Mauna Kea Access Road", desc: "Start of the journey to the summit observatory", region: "Saddle", lat: 19.7594, lng: -155.4553, heading: 0, pitch: 5, audio: { wind: 0.8 }, atmosphere: { mist: false, volcanic: false }, summary: "üî≠ This road leads to the 13,803-foot summit, home to 13 world-class observatories. Mauna Kea ('white mountain') is sacred to Hawaiians. Measured from its ocean base, it's technically taller than Everest!" },
            { id: 33, name: "Saddle Road Viewpoint", desc: "Between Mauna Kea and Mauna Loa at 6,500 feet", region: "Saddle", lat: 19.6833, lng: -155.4667, heading: 270, pitch: 0, audio: { wind: 0.9 }, atmosphere: { mist: false, volcanic: false }, treasure: { id: 'summit', name: 'Mountain Majesty', message: 'You witnessed the majesty of Mauna Kea! üèîÔ∏è' }, summary: "‚õ∞Ô∏è This high-altitude road passes between Earth's two largest mountains (by volume). Mauna Kea to the north, Mauna Loa to the south‚Äîboth over 13,000 feet, both shield volcanoes unlike any on Earth." }
        ];
        
        const ALL_REGIONS = ['Hilo', 'Hamakua', 'Puna', 'Volcano', 'Ka ª≈´', 'Kona', 'Kohala', 'Waimea', 'Saddle'];
        
        // =====================================================
        // AUDIO MANAGER - Web Audio API
        // =====================================================
        class AudioManager {
            constructor() {
                this.context = null;
                this.masterGain = null;
                this.tracks = {};
                this.buffers = {};
                this.initialized = false;
                this.masterVolume = 0.8;
                this.currentMix = {};
                this.targetMix = {};
                this.crossfadeInterval = null;
                this.windStrength = 0.2;
                this.rainIntensity = 0;
            }
            
            async init() {
                if (this.initialized) return;
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.context.createGain();
                    this.masterGain.connect(this.context.destination);
                    this.masterGain.gain.value = this.masterVolume;
                    await this.loadAllAudio();
                    this.createTracks();
                    this.initialized = true;
                    console.log('üéµ AudioManager initialized');
                    document.getElementById('audio-unlock').classList.remove('visible');
                    return true;
                } catch (error) {
                    console.error('Failed to initialize audio:', error);
                    return false;
                }
            }
            
            async loadAllAudio() {
                const loadPromises = Object.entries(AUDIO_URLS).map(async ([name, url]) => {
                    try {
                        const response = await fetch(url);
                        const arrayBuffer = await response.arrayBuffer();
                        this.buffers[name] = await this.context.decodeAudioData(arrayBuffer);
                        console.log(`‚úì Loaded: ${name}`);
                    } catch (error) {
                        console.warn(`Failed to load ${name}:`, error);
                    }
                });
                await Promise.all(loadPromises);
            }
            
            createTracks() {
                for (const name of Object.keys(AUDIO_URLS)) {
                    if (!this.buffers[name]) continue;
                    const gainNode = this.context.createGain();
                    gainNode.connect(this.masterGain);
                    gainNode.gain.value = 0;
                    const source = this.context.createBufferSource();
                    source.buffer = this.buffers[name];
                    source.loop = true;
                    source.connect(gainNode);
                    source.start(0);
                    this.tracks[name] = { source, gain: gainNode, volume: 0 };
                    this.currentMix[name] = 0;
                }
            }
            
            crossfadeTo(targetMix, duration = CONFIG.audioCrossfadeDuration) {
                if (!this.initialized) return;
                if (this.crossfadeInterval) clearInterval(this.crossfadeInterval);
                this.targetMix = { ...targetMix };
                for (const name of Object.keys(this.tracks)) {
                    if (this.targetMix[name] === undefined) this.targetMix[name] = 0;
                }
                const steps = 30;
                const stepDuration = duration / steps;
                let currentStep = 0;
                this.crossfadeInterval = setInterval(() => {
                    currentStep++;
                    const progress = currentStep / steps;
                    const eased = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;
                    for (const [name, track] of Object.entries(this.tracks)) {
                        const start = this.currentMix[name] || 0;
                        const end = this.targetMix[name] || 0;
                        const newVolume = start + (end - start) * eased;
                        track.gain.gain.setValueAtTime(newVolume * this.masterVolume, this.context.currentTime);
                        track.volume = newVolume;
                    }
                    if (currentStep >= steps) {
                        clearInterval(this.crossfadeInterval);
                        this.crossfadeInterval = null;
                        this.currentMix = { ...this.targetMix };
                    }
                }, stepDuration);
            }
            
            setMasterVolume(volume) {
                this.masterVolume = volume;
                if (this.masterGain) this.masterGain.gain.setValueAtTime(volume, this.context.currentTime);
            }
            
            setTrackVolume(name, volume) {
                if (!this.tracks[name]) return;
                this.tracks[name].gain.gain.setValueAtTime(volume * this.masterVolume, this.context.currentTime);
                this.tracks[name].volume = volume;
                this.currentMix[name] = volume;
            }
            
            toggleTrack(name, enabled) {
                if (!this.initialized) return;
                const volume = enabled ? (this.targetMix[name] || 0.5) : 0;
                this.setTrackVolume(name, volume);
            }
            
            updateWeatherAudio() {
                if (!this.initialized) return;
                if (this.rainIntensity > 0) {
                    const rainVol = this.rainIntensity / 100 * 0.8;
                    this.setTrackVolume('rain', rainVol);
                    if (this.tracks.birds) {
                        const birdVol = this.currentMix.birds || 0.5;
                        const reducedBirds = birdVol * (1 - this.rainIntensity / 150);
                        this.tracks.birds.gain.gain.setValueAtTime(Math.max(0.1, reducedBirds) * this.masterVolume, this.context.currentTime);
                    }
                } else {
                    this.setTrackVolume('rain', 0);
                }
                if (this.tracks.wind) {
                    const windVol = (this.currentMix.wind || 0) * (this.windStrength * 2);
                    this.tracks.wind.gain.gain.setValueAtTime(Math.min(1, windVol) * this.masterVolume, this.context.currentTime);
                }
            }
            
            setWindStrength(strength) { this.windStrength = strength / 100; this.updateWeatherAudio(); }
            setRainIntensity(intensity) { this.rainIntensity = intensity; this.updateWeatherAudio(); }
            resume() { if (this.context && this.context.state === 'suspended') this.context.resume(); }
        }
        
        // =====================================================
        // ATMOSPHERE MANAGER
        // =====================================================
        class AtmosphereManager {
            constructor() {
                this.currentTime = 'day';
                this.mistEnabled = false;
                this.volcanicMist = false;
                this.atmosphereLayer = document.getElementById('atmosphere-layer');
                this.mistLayer = document.getElementById('mist-layer');
            }
            
            setTimeOfDay(time) {
                this.currentTime = time;
                this.atmosphereLayer.className = `time-${time}`;
                
                // Notify visual effects manager
                if (typeof visualEffects !== 'undefined') {
                    visualEffects.applyTimeOfDayEffects(time);
                }
                
                // Auto-enable fireflies at night/dusk
                if (typeof particleManager !== 'undefined') {
                    if ((time === 'night' || time === 'dusk') && effectStates.fireflies) {
                        particleManager.toggleFireflies(true);
                    }
                }
                
                if (audioManager.initialized && audioManager.tracks.birds) {
                    let birdMod = 1;
                    switch(time) {
                        case 'dawn': birdMod = 1.2; break;
                        case 'day': birdMod = 1; break;
                        case 'golden': birdMod = 0.9; break;
                        case 'dusk': birdMod = 0.6; break;
                        case 'night': birdMod = 0.1; break;
                    }
                    const baseBird = audioManager.currentMix.birds || 0.5;
                    audioManager.tracks.birds.gain.gain.setValueAtTime(baseBird * birdMod * audioManager.masterVolume, audioManager.context.currentTime);
                }
            }
            
            setMist(enabled, volcanic = false) {
                this.mistEnabled = enabled;
                this.volcanicMist = volcanic;
                if (enabled) {
                    this.mistLayer.classList.add('active');
                    volcanic ? this.mistLayer.classList.add('volcanic') : this.mistLayer.classList.remove('volcanic');
                } else {
                    this.mistLayer.classList.remove('active');
                }
            }
            
            applyLocationAtmosphere(location) {
                if (location.atmosphere) {
                    this.setMist(location.atmosphere.mist || false, location.atmosphere.volcanic || false);
                } else {
                    this.setMist(false);
                }
            }
        }
        
        // =====================================================
        // WEATHER MANAGER
        // =====================================================
        class WeatherManager {
            constructor() {
                this.currentWeather = null;
                this.lastFetch = 0;
                this.cacheDuration = 600000; // 10 minutes
            }
            
            async fetchWeather() {
                const now = Date.now();
                if (this.currentWeather && (now - this.lastFetch) < this.cacheDuration) {
                    return this.currentWeather;
                }
                
                try {
                    // Using Open-Meteo API (free, no API key needed)
                    // Big Island central coordinates
                    const lat = 19.5;
                    const lng = -155.5;
                    const response = await fetch(
                        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,precipitation&temperature_unit=fahrenheit&wind_speed_unit=mph`
                    );
                    
                    if (!response.ok) throw new Error('Weather fetch failed');
                    
                    const data = await response.json();
                    const current = data.current;
                    
                    this.currentWeather = {
                        temp: Math.round(current.temperature_2m),
                        humidity: current.relative_humidity_2m,
                        windSpeed: Math.round(current.wind_speed_10m),
                        precipitation: current.precipitation,
                        weatherCode: current.weather_code
                    };
                    
                    this.lastFetch = now;
                    this.updateUI();
                    return this.currentWeather;
                } catch (error) {
                    console.warn('Weather fetch error:', error);
                    // Fallback data
                    this.currentWeather = { temp: 78, humidity: 70, windSpeed: 12, precipitation: 0, weatherCode: 1 };
                    this.updateUI();
                    return this.currentWeather;
                }
            }
            
            getWeatherIcon(code) {
                // WMO Weather interpretation codes
                if (code === 0) return '‚òÄÔ∏è';
                if (code <= 3) return '‚õÖ';
                if (code <= 48) return 'üå´Ô∏è';
                if (code <= 57) return 'üåßÔ∏è';
                if (code <= 67) return 'üåßÔ∏è';
                if (code <= 77) return 'üå®Ô∏è';
                if (code <= 82) return 'üåßÔ∏è';
                if (code <= 86) return 'üå®Ô∏è';
                if (code >= 95) return '‚õàÔ∏è';
                return '‚òÄÔ∏è';
            }
            
            getWeatherDescription(code) {
                if (code === 0) return 'Clear sky';
                if (code <= 3) return 'Partly cloudy';
                if (code <= 48) return 'Foggy';
                if (code <= 57) return 'Drizzle';
                if (code <= 67) return 'Rain';
                if (code <= 77) return 'Snow';
                if (code <= 82) return 'Rain showers';
                if (code <= 86) return 'Snow showers';
                if (code >= 95) return 'Thunderstorm';
                return 'Unknown';
            }
            
            updateUI() {
                if (!this.currentWeather) return;
                const w = this.currentWeather;
                document.getElementById('weather-icon').textContent = this.getWeatherIcon(w.weatherCode);
                document.getElementById('weather-temp').textContent = `${w.temp}¬∞F`;
                document.getElementById('weather-details').innerHTML = `
                    ${this.getWeatherDescription(w.weatherCode)}<br>
                    üí® ${w.windSpeed} mph ¬∑ üíß ${w.humidity}%
                `;
            }
            
            syncAmbientEffects() {
                if (!this.currentWeather) return;
                const w = this.currentWeather;
                
                // Sync rain
                let rainIntensity = 0;
                if (w.weatherCode >= 51 && w.weatherCode <= 67) rainIntensity = 30;
                if (w.weatherCode >= 80 && w.weatherCode <= 82) rainIntensity = 50;
                if (w.weatherCode >= 95) rainIntensity = 80;
                if (w.precipitation > 0) rainIntensity = Math.max(rainIntensity, Math.min(80, w.precipitation * 10));
                
                const rainSlider = document.getElementById('rain-slider');
                rainSlider.value = rainIntensity;
                document.getElementById('rain-value').textContent = `${rainIntensity}%`;
                updateRainIntensity(rainIntensity);
                
                // Sync wind
                const windStrength = Math.min(100, w.windSpeed * 3);
                const windSlider = document.getElementById('wind-slider');
                windSlider.value = windStrength;
                document.getElementById('wind-value').textContent = `${Math.round(windStrength)}%`;
                updateWindStrength(windStrength);
                
                // Enable wind sound if windy
                if (w.windSpeed > 10) {
                    const windToggle = document.querySelector('[data-effect="wind"]');
                    if (!windToggle.classList.contains('on')) {
                        windToggle.classList.add('on');
                        effectStates.wind = true;
                        audioManager.toggleTrack('wind', true);
                    }
                }
                
                // Enable mist if foggy
                if (w.weatherCode >= 45 && w.weatherCode <= 48) {
                    const mistToggle = document.querySelector('[data-effect="mist"]');
                    if (!mistToggle.classList.contains('on')) {
                        mistToggle.classList.add('on');
                        effectStates.mist = true;
                        atmosphereManager.setMist(true);
                    }
                }
                
                // Show confirmation
                showTreasure('üå§Ô∏è Weather Synced!', `Ambient effects matched to real Big Island weather.`);
            }
        }
        
        // =====================================================
        // ACHIEVEMENTS MANAGER
        // =====================================================
        class AchievementsManager {
            constructor() {
                this.visitedLocations = new Set();
                this.visitedRegions = new Set();
                this.foundTreasures = new Set();
                this.load();
            }
            
            load() {
                try {
                    const saved = localStorage.getItem('bigislandvr-achievements');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.visitedLocations = new Set(data.visitedLocations || []);
                        this.visitedRegions = new Set(data.visitedRegions || []);
                        this.foundTreasures = new Set(data.foundTreasures || []);
                    }
                } catch (e) {
                    console.warn('Failed to load achievements:', e);
                }
                this.updateUI();
            }
            
            save() {
                try {
                    localStorage.setItem('bigislandvr-achievements', JSON.stringify({
                        visitedLocations: [...this.visitedLocations],
                        visitedRegions: [...this.visitedRegions],
                        foundTreasures: [...this.foundTreasures]
                    }));
                } catch (e) {
                    console.warn('Failed to save achievements:', e);
                }
            }
            
            visitLocation(location) {
                const wasNew = !this.visitedLocations.has(location.id);
                this.visitedLocations.add(location.id);
                this.visitedRegions.add(location.region);
                
                // Check for treasure
                if (location.treasure && !this.foundTreasures.has(location.treasure.id)) {
                    // 30% chance to find treasure on first visit
                    if (wasNew && Math.random() < 0.3) {
                        this.foundTreasures.add(location.treasure.id);
                        showTreasure(location.treasure.name, location.treasure.message);
                    }
                }
                
                this.save();
                this.updateUI();
            }
            
            updateUI() {
                const locPct = (this.visitedLocations.size / LOCATIONS.length) * 100;
                const regPct = (this.visitedRegions.size / 9) * 100; // 9 regions total
                
                document.getElementById('locations-fill').style.width = `${locPct}%`;
                document.getElementById('locations-progress').textContent = `Visited: ${this.visitedLocations.size}/${LOCATIONS.length} locations`;
                
                document.getElementById('regions-fill').style.width = `${regPct}%`;
                document.getElementById('regions-progress').textContent = `Regions: ${this.visitedRegions.size}/9 explored`;
                
                document.getElementById('treasures-found').textContent = this.foundTreasures.size;
            }
        }
        
        // =====================================================
        // PERFORMANCE MONITOR
        // =====================================================
        class PerformanceMonitor {
            constructor() {
                this.fps = 60;
                this.frameCount = 0;
                this.lastTime = performance.now();
                this.visible = false;
                this.isLoading = false;
            }
            
            start() {
                this.update();
            }
            
            update() {
                this.frameCount++;
                const now = performance.now();
                const delta = now - this.lastTime;
                
                if (delta >= 1000) {
                    this.fps = Math.round((this.frameCount * 1000) / delta);
                    this.frameCount = 0;
                    this.lastTime = now;
                    
                    if (this.visible) {
                        this.updateUI();
                    }
                }
                
                requestAnimationFrame(() => this.update());
            }
            
            updateUI() {
                const fpsEl = document.getElementById('perf-fps');
                fpsEl.textContent = this.fps;
                fpsEl.className = 'perf-value';
                if (this.fps < 30) fpsEl.classList.add('danger');
                else if (this.fps < 50) fpsEl.classList.add('warning');
                
                // Memory (if available)
                const memEl = document.getElementById('perf-mem');
                if (performance.memory) {
                    const mb = Math.round(performance.memory.usedJSHeapSize / 1048576);
                    memEl.textContent = `${mb} MB`;
                    memEl.className = 'perf-value';
                    if (mb > 500) memEl.classList.add('danger');
                    else if (mb > 200) memEl.classList.add('warning');
                } else {
                    memEl.textContent = 'N/A';
                }
                
                // Network status
                const netIndicator = document.getElementById('perf-net-indicator');
                const netEl = document.getElementById('perf-net');
                netIndicator.className = 'perf-indicator';
                if (this.isLoading) {
                    netIndicator.classList.add('loading');
                    netEl.textContent = 'Loading...';
                } else {
                    netEl.textContent = 'Ready';
                }
            }
            
            setLoading(loading) {
                this.isLoading = loading;
                if (this.visible) this.updateUI();
            }
            
            toggle() {
                this.visible = !this.visible;
                document.getElementById('perf-dashboard').classList.toggle('visible', this.visible);
                if (this.visible) this.updateUI();
            }
        }
        
        // =====================================================
        // SHARING MANAGER
        // =====================================================
        class SharingManager {
            getShareUrl() {
                const loc = LOCATIONS[currentIndex];
                const pov = streetViewPanorama.getPov();
                const params = new URLSearchParams({
                    loc: currentIndex,
                    h: Math.round(pov.heading),
                    p: Math.round(pov.pitch),
                    z: streetViewPanorama.getZoom() || 1
                });
                return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            }
            
            getEmbedCode() {
                const url = this.getShareUrl();
                return `<iframe src="${url}" width="800" height="600" frameborder="0" allowfullscreen></iframe>`;
            }
            
            updatePanel() {
                const url = this.getShareUrl();
                document.getElementById('share-url').textContent = url;
                document.getElementById('embed-code').textContent = this.getEmbedCode();
            }
            
            shareTwitter() {
                const loc = LOCATIONS[currentIndex];
                const text = `üå¥ Exploring ${loc.name} on Big Island VR! Virtual tour of Hawai ªi`;
                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(this.getShareUrl())}`, '_blank');
            }
            
            shareFacebook() {
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(this.getShareUrl())}`, '_blank');
            }
            
            shareLinkedIn() {
                const loc = LOCATIONS[currentIndex];
                window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(this.getShareUrl())}`, '_blank');
            }
            
            async copyUrl() {
                try {
                    await navigator.clipboard.writeText(this.getShareUrl());
                    showTreasure('üìã Copied!', 'Link copied to clipboard');
                } catch (e) {
                    console.warn('Copy failed:', e);
                }
            }
            
            async copyEmbed() {
                try {
                    await navigator.clipboard.writeText(this.getEmbedCode());
                    showTreasure('üìã Copied!', 'Embed code copied to clipboard');
                } catch (e) {
                    console.warn('Copy failed:', e);
                }
            }
            
            parseUrlParams() {
                const params = new URLSearchParams(window.location.search);
                const loc = params.get('loc');
                const h = params.get('h');
                const p = params.get('p');
                const z = params.get('z');
                
                return {
                    locationIndex: loc !== null ? parseInt(loc) : null,
                    heading: h !== null ? parseFloat(h) : null,
                    pitch: p !== null ? parseFloat(p) : null,
                    zoom: z !== null ? parseFloat(z) : null
                };
            }
        }
        
        // =====================================================
        // STREET VIEW NAVIGATION
        // =====================================================
        class StreetViewNavigator {
            constructor() {
                this.links = [];
            }
            
            updateLinks() {
                if (!streetViewPanorama) return;
                
                const panoLinks = streetViewPanorama.getLinks();
                this.links = panoLinks || [];
                
                this.updateArrows();
            }
            
            updateArrows() {
                const pov = streetViewPanorama.getPov();
                const heading = pov.heading;
                
                // Find links in each direction (forward, left, right, back)
                const forward = this.findLinkInDirection(heading, 45);
                const left = this.findLinkInDirection(heading - 90, 45);
                const right = this.findLinkInDirection(heading + 90, 45);
                const backward = this.findLinkInDirection(heading + 180, 45);
                
                document.getElementById('nav-forward').classList.toggle('available', !!forward);
                document.getElementById('nav-forward').dataset.pano = forward?.pano || '';
                
                document.getElementById('nav-left').classList.toggle('available', !!left);
                document.getElementById('nav-left').dataset.pano = left?.pano || '';
                
                document.getElementById('nav-right').classList.toggle('available', !!right);
                document.getElementById('nav-right').dataset.pano = right?.pano || '';
                
                document.getElementById('nav-backward').classList.toggle('available', !!backward);
                document.getElementById('nav-backward').dataset.pano = backward?.pano || '';
            }
            
            findLinkInDirection(targetHeading, tolerance) {
                targetHeading = ((targetHeading % 360) + 360) % 360;
                
                let best = null;
                let bestDiff = tolerance;
                
                for (const link of this.links) {
                    let diff = Math.abs(link.heading - targetHeading);
                    if (diff > 180) diff = 360 - diff;
                    
                    if (diff < bestDiff) {
                        bestDiff = diff;
                        best = link;
                    }
                }
                
                return best;
            }
            
            moveTo(panoId) {
                if (!panoId || !streetViewPanorama) return;
                
                perfMonitor.setLoading(true);
                streetViewPanorama.setPano(panoId);
            }
            
            moveForward() {
                const btn = document.getElementById('nav-forward');
                if (btn.dataset.pano) this.moveTo(btn.dataset.pano);
            }
            
            moveBackward() {
                const btn = document.getElementById('nav-backward');
                if (btn.dataset.pano) this.moveTo(btn.dataset.pano);
            }
            
            turnLeft() {
                const pov = streetViewPanorama.getPov();
                streetViewPanorama.setPov({ heading: pov.heading - 45, pitch: pov.pitch });
            }
            
            turnRight() {
                const pov = streetViewPanorama.getPov();
                streetViewPanorama.setPov({ heading: pov.heading + 45, pitch: pov.pitch });
            }
        }
        
        // =====================================================
        // TIME TRAVEL (Historical Imagery)
        // =====================================================
        class TimeTravelManager {
            constructor() {
                this.availableYears = [];
                this.currentYear = null;
                this.visible = false;
                this.container = document.getElementById('time-travel-options');
            }
            
            async checkAvailability() {
                if (!streetViewPanorama || !streetViewService) return;
                
                const pano = streetViewPanorama.getPano();
                if (!pano) return;
                
                // Show panel while checking
                this.visible = true;
                document.getElementById('time-travel').classList.add('visible');
                this.container.innerHTML = '<div class="time-travel-loading">Checking history...</div>';
                
                // Get panorama metadata to find available dates
                const location = LOCATIONS[currentIndex];
                const searchLocation = new google.maps.LatLng(location.lat, location.lng);
                
                try {
                    // Try to get panorama with time machine data
                    streetViewService.getPanorama({
                        location: searchLocation,
                        radius: 100,
                        source: google.maps.StreetViewSource.OUTDOOR
                    }, (data, status) => {
                        if (status === google.maps.StreetViewStatus.OK && data.time) {
                            // Parse available time periods from the response
                            const times = data.time || [];
                            this.availableYears = [];
                            
                            times.forEach(t => {
                                const date = new Date(t.pano);
                                if (!isNaN(date)) {
                                    this.availableYears.push({
                                        year: date.getFullYear(),
                                        month: date.getMonth() + 1,
                                        pano: t.pano
                                    });
                                }
                            });
                            
                            // Also check imageDate from current pano
                            if (data.imageDate) {
                                const currentYear = parseInt(data.imageDate.split('-')[0]);
                                if (!this.availableYears.find(y => y.year === currentYear)) {
                                    this.availableYears.push({ year: currentYear, pano: data.location.pano, current: true });
                                }
                            }
                            
                            // Sort by year descending
                            this.availableYears.sort((a, b) => b.year - a.year);
                            
                            if (this.availableYears.length > 0) {
                                this.renderOptions();
                            } else {
                                this.container.innerHTML = '<div class="time-travel-loading">No historical imagery available</div>';
                            }
                        } else {
                            // Fallback: assume current year only
                            const currentYear = new Date().getFullYear();
                            this.availableYears = [{ year: currentYear, pano: pano, current: true }];
                            this.renderOptions();
                        }
                    });
                } catch (e) {
                    this.container.innerHTML = '<div class="time-travel-loading">Unable to check history</div>';
                }
            }
            
            renderOptions() {
                this.container.innerHTML = '';
                const currentYear = new Date().getFullYear();
                
                // Group by year and show unique years
                const uniqueYears = [...new Set(this.availableYears.map(y => y.year))].sort((a, b) => b - a);
                
                uniqueYears.forEach((year, index) => {
                    const yearData = this.availableYears.find(y => y.year === year);
                    const isRecent = year >= currentYear - 1;
                    
                    const option = document.createElement('div');
                    option.className = 'time-travel-option' + (index === 0 ? ' active' : '');
                    option.innerHTML = `
                        <input type="radio" name="timetravel" id="tt-${year}" value="${year}" ${index === 0 ? 'checked' : ''}>
                        <label for="tt-${year}">${year}${isRecent ? ' (Recent)' : ''}</label>
                    `;
                    
                    option.addEventListener('click', () => {
                        this.selectYear(year, yearData.pano);
                        document.querySelectorAll('.time-travel-option').forEach(o => o.classList.remove('active'));
                        option.classList.add('active');
                        option.querySelector('input').checked = true;
                    });
                    
                    this.container.appendChild(option);
                });
                
                // Update header
                if (uniqueYears.length > 0) {
                    document.getElementById('time-travel-year').textContent = uniqueYears[0];
                }
            }
            
            selectYear(year, panoId) {
                document.getElementById('time-travel-year').textContent = year;
                this.currentYear = year;
                
                // Visual feedback
                const overlay = document.getElementById('transition-overlay');
                overlay.classList.add('active');
                setTimeout(() => overlay.classList.remove('active'), 300);
                
                // If we have a pano ID, try to switch to it
                // Note: Full time machine functionality requires the embed API
                if (panoId && streetViewPanorama) {
                    try {
                        streetViewPanorama.setPano(panoId);
                    } catch (e) {
                        console.warn('Could not switch to historical pano:', e);
                    }
                }
            }
            
            hide() {
                this.visible = false;
                document.getElementById('time-travel').classList.remove('visible');
            }
        }
        
        // =====================================================
        // LOADING TIPS
        // =====================================================
        const LOADING_TIPS = [
            "üí° Use arrow keys to navigate between locations",
            "üå¥ The Big Island is larger than all other Hawaiian islands combined",
            "üåã Kƒ´lauea is one of the world's most active volcanoes",
            "üéµ Click 'Enable Audio' for ambient sounds",
            "‚è±Ô∏è Press Space to start/stop auto-tour",
            "üåÖ Try different times of day in the Effects panel",
            "üì∏ Take screenshots with filters and watermarks",
            "ü¶ã Enable particle effects for extra immersion",
            "üèÜ Visit all locations to unlock achievements",
            "ü§ô 'Aloha' means love, affection, and peace",
            "üå∫ Hawaii's state flower is the yellow hibiscus",
            "üê¢ Sea turtles (honu) are sacred in Hawaiian culture",
            "‚òï Kona coffee is world-famous for its smooth flavor",
            "üåà Rainbow Falls gets its name from morning rainbows"
        ];
        
        // =====================================================
        // VISUAL EFFECTS MANAGER
        // =====================================================
        class VisualEffectsManager {
            constructor() {
                this.vignetteEnabled = false;
                this.lensFlareEnabled = false;
                this.bloomEnabled = false;
                this.colorGrade = 'none';
                this.sunPosition = { x: 70, y: 15 };
                
                this.vignetteLayer = document.getElementById('vignette-layer');
                this.lensFlare = document.getElementById('lens-flare');
                this.bloomLayer = document.getElementById('bloom-layer');
                this.colorGradeLayer = document.getElementById('color-grade');
            }
            
            setVignette(enabled) {
                this.vignetteEnabled = enabled;
                this.vignetteLayer.classList.toggle('active', enabled);
            }
            
            setLensFlare(enabled) {
                this.lensFlareEnabled = enabled;
                this.lensFlare.classList.toggle('active', enabled);
            }
            
            setBloom(enabled, style = 'day') {
                this.bloomEnabled = enabled;
                this.bloomLayer.className = enabled ? `active ${style}` : '';
            }
            
            setColorGrade(grade) {
                this.colorGrade = grade;
                this.colorGradeLayer.className = grade !== 'none' ? `active ${grade}` : '';
            }
            
            updateSunPosition(heading) {
                // Calculate sun position based on camera heading
                const normalizedHeading = ((heading % 360) + 360) % 360;
                const sunX = 50 + Math.sin((normalizedHeading - 90) * Math.PI / 180) * 40;
                const sunY = 20;
                
                this.sunPosition = { x: sunX, y: sunY };
                
                if (this.lensFlareEnabled) {
                    const flareMain = this.lensFlare.querySelector('.flare-main');
                    const flareSecondary = this.lensFlare.querySelector('.flare-secondary');
                    if (flareMain) {
                        flareMain.style.left = `${sunX}%`;
                        flareMain.style.top = `${sunY}%`;
                    }
                    if (flareSecondary) {
                        flareSecondary.style.left = `${sunX - 10}%`;
                        flareSecondary.style.top = `${sunY + 10}%`;
                    }
                }
            }
            
            applyTimeOfDayEffects(time) {
                // Adjust bloom based on time
                if (this.bloomEnabled) {
                    switch(time) {
                        case 'dawn':
                        case 'golden':
                            this.setBloom(true, 'golden');
                            break;
                        case 'day':
                            this.setBloom(true, 'day');
                            break;
                        default:
                            this.setBloom(false);
                    }
                }
                
                // Auto-enable lens flare for day/golden
                if (time === 'day' || time === 'golden') {
                    if (this.lensFlareEnabled) {
                        this.lensFlare.classList.add('active');
                    }
                } else {
                    this.lensFlare.classList.remove('active');
                }
            }
        }
        
        // =====================================================
        // PARTICLE SYSTEM MANAGER
        // =====================================================
        class ParticleManager {
            constructor() {
                this.butterflies = [];
                this.fireflies = [];
                this.leaves = [];
                this.ashParticles = [];
                this.sprayParticles = [];
                
                this.butterfliesEnabled = false;
                this.firefliesEnabled = false;
                this.leavesEnabled = false;
                this.ashEnabled = false;
                this.sprayEnabled = false;
                
                this.containers = {
                    butterflies: document.getElementById('butterflies-container'),
                    fireflies: document.getElementById('fireflies-container'),
                    leaves: document.getElementById('leaves-container'),
                    ash: document.getElementById('ash-container'),
                    spray: document.getElementById('spray-container')
                };
            }
            
            toggleButterflies(enabled) {
                this.butterfliesEnabled = enabled;
                this.containers.butterflies.classList.toggle('active', enabled);
                if (enabled && this.butterflies.length === 0) {
                    this.createButterflies();
                }
            }
            
            createButterflies() {
                const container = this.containers.butterflies;
                container.innerHTML = '';
                const butterflyEmojis = ['ü¶ã', 'ü¶ã', 'ü¶ã'];
                const colors = ['hue-rotate(0deg)', 'hue-rotate(30deg)', 'hue-rotate(180deg)', 'hue-rotate(270deg)'];
                
                for (let i = 0; i < 8; i++) {
                    const butterfly = document.createElement('div');
                    butterfly.className = 'butterfly';
                    butterfly.textContent = butterflyEmojis[Math.floor(Math.random() * butterflyEmojis.length)];
                    butterfly.style.left = `${Math.random() * 80 + 10}%`;
                    butterfly.style.top = `${Math.random() * 60 + 20}%`;
                    butterfly.style.animationDelay = `${Math.random() * 5}s`;
                    butterfly.style.animationDuration = `${12 + Math.random() * 8}s`;
                    butterfly.style.filter = colors[Math.floor(Math.random() * colors.length)];
                    container.appendChild(butterfly);
                    this.butterflies.push(butterfly);
                }
            }
            
            toggleFireflies(enabled) {
                this.firefliesEnabled = enabled;
                this.containers.fireflies.classList.toggle('active', enabled);
                if (enabled && this.fireflies.length === 0) {
                    this.createFireflies();
                }
            }
            
            createFireflies() {
                const container = this.containers.fireflies;
                container.innerHTML = '';
                
                for (let i = 0; i < 25; i++) {
                    const firefly = document.createElement('div');
                    firefly.className = 'firefly';
                    firefly.style.left = `${Math.random() * 90 + 5}%`;
                    firefly.style.top = `${Math.random() * 70 + 15}%`;
                    firefly.style.animationDelay = `${Math.random() * 4}s, ${Math.random() * 2}s`;
                    firefly.style.animationDuration = `${6 + Math.random() * 4}s, ${1.5 + Math.random() * 1}s`;
                    container.appendChild(firefly);
                    this.fireflies.push(firefly);
                }
            }
            
            toggleLeaves(enabled) {
                this.leavesEnabled = enabled;
                this.containers.leaves.classList.toggle('active', enabled);
                if (enabled && this.leaves.length === 0) {
                    this.createLeaves();
                }
            }
            
            createLeaves() {
                const container = this.containers.leaves;
                container.innerHTML = '';
                const leafEmojis = ['üçÇ', 'üçÉ', 'üåø', 'üçÅ'];
                
                for (let i = 0; i < 15; i++) {
                    const leaf = document.createElement('div');
                    leaf.className = 'leaf';
                    leaf.textContent = leafEmojis[Math.floor(Math.random() * leafEmojis.length)];
                    leaf.style.left = `${Math.random() * 100}%`;
                    leaf.style.animationDelay = `${Math.random() * 10}s`;
                    leaf.style.animationDuration = `${8 + Math.random() * 6}s`;
                    container.appendChild(leaf);
                    this.leaves.push(leaf);
                }
            }
            
            toggleAsh(enabled) {
                this.ashEnabled = enabled;
                this.containers.ash.classList.toggle('active', enabled);
                if (enabled && this.ashParticles.length === 0) {
                    this.createAsh();
                }
            }
            
            createAsh() {
                const container = this.containers.ash;
                container.innerHTML = '';
                
                for (let i = 0; i < 50; i++) {
                    const ash = document.createElement('div');
                    ash.className = 'ash-particle';
                    ash.style.left = `${Math.random() * 100}%`;
                    ash.style.width = `${2 + Math.random() * 3}px`;
                    ash.style.height = ash.style.width;
                    ash.style.animationDelay = `${Math.random() * 8}s`;
                    ash.style.animationDuration = `${5 + Math.random() * 5}s`;
                    ash.style.opacity = 0.3 + Math.random() * 0.5;
                    container.appendChild(ash);
                    this.ashParticles.push(ash);
                }
            }
            
            toggleSpray(enabled) {
                this.sprayEnabled = enabled;
                this.containers.spray.classList.toggle('active', enabled);
                if (enabled && this.sprayParticles.length === 0) {
                    this.createSpray();
                }
            }
            
            createSpray() {
                const container = this.containers.spray;
                container.innerHTML = '';
                
                for (let i = 0; i < 30; i++) {
                    const spray = document.createElement('div');
                    spray.className = 'spray-particle';
                    spray.style.left = `${Math.random() * 100}%`;
                    spray.style.animationDelay = `${Math.random() * 3}s`;
                    spray.style.animationDuration = `${2 + Math.random() * 2}s`;
                    container.appendChild(spray);
                    this.sprayParticles.push(spray);
                }
            }
            
            applyLocationParticles(location) {
                // Auto-enable particles based on location
                const isVolcanic = location.atmosphere?.volcanic;
                const isCoastal = location.audio?.ocean > 0.6;
                const isForest = location.audio?.birds > 0.5 && !isCoastal;
                const isNight = atmosphereManager.currentTime === 'night' || atmosphereManager.currentTime === 'dusk';
                
                // Suggest particles but don't force them
                if (isVolcanic && !this.ashEnabled) {
                    // Could auto-enable, but let user control
                }
            }
        }
        
        // =====================================================
        // SCREENSHOT MANAGER
        // =====================================================
        class ScreenshotManager {
            constructor() {
                this.watermarkEnabled = false;
                this.stampEnabled = false;
                this.flashElement = document.getElementById('screenshot-flash');
                this.watermarkElement = document.getElementById('screenshot-watermark');
                this.stampElement = document.getElementById('screenshot-stamp');
            }
            
            setWatermark(enabled) {
                this.watermarkEnabled = enabled;
            }
            
            setStamp(enabled) {
                this.stampEnabled = enabled;
            }
            
            async takeScreenshot() {
                const location = LOCATIONS[currentIndex];
                const now = new Date();
                
                // Show watermark/stamp if enabled
                if (this.watermarkEnabled) {
                    this.watermarkElement.classList.add('visible');
                }
                if (this.stampEnabled) {
                    this.stampElement.textContent = `üìç ${location.name} ‚Ä¢ ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
                    this.stampElement.classList.add('visible');
                }
                
                // Flash effect
                this.flashElement.classList.add('flash');
                setTimeout(() => this.flashElement.classList.remove('flash'), 150);
                
                // Wait for elements to render
                await new Promise(resolve => setTimeout(resolve, 100));
                
                try {
                    // Use html2canvas if available, otherwise basic approach
                    const viewer = document.getElementById('viewer');
                    
                    if (typeof html2canvas !== 'undefined') {
                        const canvas = await html2canvas(viewer, {
                            useCORS: true,
                            allowTaint: true,
                            scale: 2
                        });
                        this.downloadCanvas(canvas, location.name);
                    } else {
                        // Fallback: just notify user
                        showTreasure('üì∏ Screenshot Ready!', 'Press Ctrl+Shift+S or use browser screenshot');
                    }
                } catch (error) {
                    console.warn('Screenshot failed:', error);
                    showTreasure('üì∏ Screenshot', 'Use Ctrl+Shift+S for browser screenshot');
                }
                
                // Hide overlays
                setTimeout(() => {
                    this.watermarkElement.classList.remove('visible');
                    this.stampElement.classList.remove('visible');
                }, 500);
            }
            
            downloadCanvas(canvas, locationName) {
                const link = document.createElement('a');
                link.download = `BigIslandVR-${locationName.replace(/\s+/g, '-')}-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showTreasure('üì∏ Screenshot Saved!', `${locationName} captured`);
            }
        }
        
        // =====================================================
        // TRANSITION MANAGER
        // =====================================================
        class TransitionManager {
            constructor() {
                this.overlay = document.getElementById('transition-overlay');
                this.currentTransition = 'fade';
            }
            
            async transitionTo(type = 'fade') {
                this.currentTransition = type;
                this.overlay.className = '';
                
                switch(type) {
                    case 'blur':
                        this.overlay.classList.add('active', 'blur-active');
                        break;
                    case 'flyover':
                        this.overlay.classList.add('active', 'flyover');
                        break;
                    default:
                        this.overlay.classList.add('active');
                }
                
                return new Promise(resolve => setTimeout(resolve, CONFIG.transitionDuration / 2));
            }
            
            async complete() {
                await new Promise(resolve => setTimeout(resolve, 300));
                this.overlay.classList.remove('active', 'blur-active', 'flyover');
            }
            
            getTransitionType(fromLocation, toLocation) {
                // Calculate distance
                const distance = getDistanceFromLatLng(
                    fromLocation.lat, fromLocation.lng,
                    toLocation.lat, toLocation.lng
                );
                
                // Use flyover for distant locations (>20km)
                if (distance > 20000) return 'flyover';
                // Use blur for medium distances
                if (distance > 5000) return 'blur';
                // Simple fade for nearby
                return 'fade';
            }
        }
        
        // =====================================================
        // SHADER ANIMATION MANAGER
        // =====================================================
        class ShaderAnimationManager {
            constructor() {
                this.canvas = document.getElementById('shader-animation-canvas');
                this.gl = null;
                this.program = null;
                this.enabled = false;
                this.animating = false;
                this.startTime = 0;
                this.animationFrame = null;
                
                // Intensity settings (David's preferences)
                this.cloudDrift = 1.0;      // 100%
                this.waterRipple = 0.5;     // 50%
                this.vegSway = 0.3;         // 30%
                
                // Textures
                this.skyMask = null;
                this.waterMask = null;
                this.vegMask = null;
                this.hasMasks = false;
                
                // Location-to-mask mapping (location name to mask filename)
                // Maps full location names to mask file prefixes
                this.maskMappings = {
                    "Ali ªi Drive, Kailua-Kona": "alii-drive",
                    "Hilo Bayfront": "hilo-bayfront", 
                    "Punalu'u Black Sand Beach": "punaluu-beach",
                    "Kea ªau Town Center": "keaau"
                };
                
                this.currentLocationSlug = null;
                this.statusEl = document.getElementById('scene-anim-status');
                this.statusTextEl = document.getElementById('scene-anim-status-text');
            }
            
            init() {
                if (!this.canvas) return false;
                
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                try {
                    this.gl = this.canvas.getContext('webgl', { 
                        alpha: true, 
                        premultipliedAlpha: false,
                        preserveDrawingBuffer: true
                    });
                    if (!this.gl) {
                        console.warn('WebGL not supported for shader animations');
                        return false;
                    }
                    
                    this.createShaderProgram();
                    this.createGeometry();
                    this.setupUniforms();
                    
                    window.addEventListener('resize', () => this.handleResize());
                    
                    console.log('üé¨ ShaderAnimationManager initialized');
                    return true;
                } catch (e) {
                    console.warn('Shader animation init failed:', e);
                    return false;
                }
            }
            
            createShaderProgram() {
                const gl = this.gl;
                
                // Vertex shader - simple pass-through
                const vertexSource = `
                    attribute vec2 a_position;
                    attribute vec2 a_texCoord;
                    varying vec2 v_texCoord;
                    void main() {
                        gl_Position = vec4(a_position, 0.0, 1.0);
                        v_texCoord = a_texCoord;
                    }
                `;
                
                // Fragment shader - creates displacement overlay effect
                const fragmentSource = `
                    precision mediump float;
                    varying vec2 v_texCoord;
                    
                    uniform float u_time;
                    uniform float u_cloudIntensity;
                    uniform float u_waterIntensity;
                    uniform float u_vegIntensity;
                    uniform sampler2D u_skyMask;
                    uniform sampler2D u_waterMask;
                    uniform sampler2D u_vegMask;
                    uniform vec2 u_resolution;
                    uniform bool u_hasMasks;
                    
                    // Simplex noise functions
                    vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
                    vec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
                    vec3 permute(vec3 x) { return mod289(((x*34.0)+1.0)*x); }
                    
                    float snoise(vec2 v) {
                        const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
                        vec2 i = floor(v + dot(v, C.yy));
                        vec2 x0 = v - i + dot(i, C.xx);
                        vec2 i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
                        vec4 x12 = x0.xyxy + C.xxzz;
                        x12.xy -= i1;
                        i = mod289(i);
                        vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
                        vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
                        m = m*m; m = m*m;
                        vec3 x = 2.0 * fract(p * C.www) - 1.0;
                        vec3 h = abs(x) - 0.5;
                        vec3 ox = floor(x + 0.5);
                        vec3 a0 = x - ox;
                        m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
                        vec3 g;
                        g.x = a0.x * x0.x + h.x * x0.y;
                        g.yz = a0.yz * x12.xz + h.yz * x12.yw;
                        return 130.0 * dot(m, g);
                    }
                    
                    void main() {
                        vec2 uv = v_texCoord;
                        
                        // Sample masks (or use fallback gradients)
                        float skyMaskVal, waterMaskVal, vegMaskVal;
                        
                        if (u_hasMasks) {
                            skyMaskVal = texture2D(u_skyMask, uv).r;
                            waterMaskVal = texture2D(u_waterMask, uv).r;
                            vegMaskVal = texture2D(u_vegMask, uv).r;
                        } else {
                            // Fallback gradient masks
                            // Sky: top 40% of screen
                            skyMaskVal = smoothstep(0.6, 0.4, uv.y);
                            // Water: bottom 30% (if coastal - we apply everywhere subtly)
                            waterMaskVal = smoothstep(0.3, 0.0, uv.y) * 0.5;
                            // Vegetation: sides and middle-lower area
                            vegMaskVal = (1.0 - abs(uv.x - 0.5) * 1.5) * smoothstep(0.7, 0.4, uv.y) * 0.3;
                        }
                        
                        // Calculate distortions for each element
                        vec2 totalDistortion = vec2(0.0);
                        float alpha = 0.0;
                        
                        // Cloud drift - slow, flowing motion
                        if (skyMaskVal > 0.05 && u_cloudIntensity > 0.0) {
                            float drift = snoise(uv * 2.0 + u_time * 0.02) * 0.006;
                            float morph = snoise(uv * 3.0 + u_time * 0.03) * 0.004;
                            totalDistortion += vec2(drift, morph * 0.3) * u_cloudIntensity * skyMaskVal;
                            alpha += skyMaskVal * u_cloudIntensity * 0.02;
                        }
                        
                        // Water ripples - faster, wave-like
                        if (waterMaskVal > 0.05 && u_waterIntensity > 0.0) {
                            float wave1 = sin(uv.x * 25.0 + u_time * 1.2) * 0.003;
                            float wave2 = sin(uv.y * 20.0 + u_time * 0.9) * 0.002;
                            float ripple = snoise(uv * 12.0 + u_time * 0.4) * 0.004;
                            totalDistortion += vec2(wave1 + ripple, wave2 + ripple * 0.5) * u_waterIntensity * waterMaskVal;
                            alpha += waterMaskVal * u_waterIntensity * 0.03;
                        }
                        
                        // Vegetation sway - gentle, rhythmic
                        if (vegMaskVal > 0.05 && u_vegIntensity > 0.0) {
                            float sway = sin(u_time * 0.5 + uv.x * 8.0) * 0.004;
                            float rustle = snoise(uv * 10.0 + u_time * 0.3) * 0.003;
                            totalDistortion += vec2(sway + rustle, rustle * 0.2) * u_vegIntensity * vegMaskVal;
                            alpha += vegMaskVal * u_vegIntensity * 0.015;
                        }
                        
                        // Create visible motion effect through color modulation
                        float distortMagnitude = length(totalDistortion);
                        
                        // Base gray that will be modulated
                        vec3 baseColor = vec3(0.5);
                        
                        // Apply distortion as brightness variation - creates visible "motion" effect
                        float brightness = 0.5 + (totalDistortion.x + totalDistortion.y) * 15.0;
                        
                        // Region-based color tinting
                        vec3 tint = vec3(brightness);
                        // Sky gets slight blue shift when moving
                        tint += vec3(-0.02, 0.0, 0.03) * skyMaskVal * u_cloudIntensity * distortMagnitude * 50.0;
                        // Water gets cyan shimmer
                        tint += vec3(-0.02, 0.02, 0.04) * waterMaskVal * u_waterIntensity * distortMagnitude * 50.0;
                        // Vegetation gets subtle green
                        tint += vec3(-0.01, 0.02, -0.01) * vegMaskVal * u_vegIntensity * distortMagnitude * 50.0;
                        
                        // Alpha based on distortion amount - visible where there's movement
                        float outputAlpha = distortMagnitude * 8.0;
                        outputAlpha = clamp(outputAlpha, 0.0, 0.4);
                        
                        gl_FragColor = vec4(tint, outputAlpha);
                    }
                `;
                
                const vertexShader = this.compileShader(gl.VERTEX_SHADER, vertexSource);
                const fragmentShader = this.compileShader(gl.FRAGMENT_SHADER, fragmentSource);
                
                this.program = gl.createProgram();
                gl.attachShader(this.program, vertexShader);
                gl.attachShader(this.program, fragmentShader);
                gl.linkProgram(this.program);
                
                if (!gl.getProgramParameter(this.program, gl.LINK_STATUS)) {
                    console.error('Shader program link failed:', gl.getProgramInfoLog(this.program));
                }
            }
            
            compileShader(type, source) {
                const gl = this.gl;
                const shader = gl.createShader(type);
                gl.shaderSource(shader, source);
                gl.compileShader(shader);
                
                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                    console.error('Shader compile failed:', gl.getShaderInfoLog(shader));
                }
                return shader;
            }
            
            createGeometry() {
                const gl = this.gl;
                
                // Full-screen quad
                const positions = new Float32Array([
                    -1, -1,  1, -1,  -1, 1,
                    -1,  1,  1, -1,   1, 1
                ]);
                
                const texCoords = new Float32Array([
                    0, 0,  1, 0,  0, 1,
                    0, 1,  1, 0,  1, 1
                ]);
                
                const posBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, posBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);
                
                const posLocation = gl.getAttribLocation(this.program, 'a_position');
                gl.enableVertexAttribArray(posLocation);
                gl.vertexAttribPointer(posLocation, 2, gl.FLOAT, false, 0, 0);
                
                const texBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, texBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, texCoords, gl.STATIC_DRAW);
                
                const texLocation = gl.getAttribLocation(this.program, 'a_texCoord');
                gl.enableVertexAttribArray(texLocation);
                gl.vertexAttribPointer(texLocation, 2, gl.FLOAT, false, 0, 0);
            }
            
            setupUniforms() {
                const gl = this.gl;
                gl.useProgram(this.program);
                
                this.uniforms = {
                    time: gl.getUniformLocation(this.program, 'u_time'),
                    cloudIntensity: gl.getUniformLocation(this.program, 'u_cloudIntensity'),
                    waterIntensity: gl.getUniformLocation(this.program, 'u_waterIntensity'),
                    vegIntensity: gl.getUniformLocation(this.program, 'u_vegIntensity'),
                    skyMask: gl.getUniformLocation(this.program, 'u_skyMask'),
                    waterMask: gl.getUniformLocation(this.program, 'u_waterMask'),
                    vegMask: gl.getUniformLocation(this.program, 'u_vegMask'),
                    resolution: gl.getUniformLocation(this.program, 'u_resolution'),
                    hasMasks: gl.getUniformLocation(this.program, 'u_hasMasks')
                };
                
                // Create placeholder textures
                this.skyMask = this.createEmptyTexture(0);
                this.waterMask = this.createEmptyTexture(1);
                this.vegMask = this.createEmptyTexture(2);
            }
            
            createEmptyTexture(unit) {
                const gl = this.gl;
                const texture = gl.createTexture();
                gl.activeTexture(gl.TEXTURE0 + unit);
                gl.bindTexture(gl.TEXTURE_2D, texture);
                
                // 1x1 transparent pixel
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, new Uint8Array([0, 0, 0, 0]));
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
                
                return texture;
            }
            
            async loadMasksForLocation(locationName) {
                if (!this.gl) return;
                
                const maskPrefix = this.maskMappings[locationName];
                const hasMasks = !!maskPrefix;
                
                this.showStatus(hasMasks ? `Loading masks for ${locationName.split(',')[0]}...` : 'Using gradient effects');
                
                if (hasMasks) {
                    try {
                        const basePath = 'ai-motion/masks/';
                        await Promise.all([
                            this.loadTexture(`${basePath}${maskPrefix}-sky.png`, 0, this.skyMask),
                            this.loadTexture(`${basePath}${maskPrefix}-water.png`, 1, this.waterMask),
                            this.loadTexture(`${basePath}${maskPrefix}-veg.png`, 2, this.vegMask)
                        ]);
                        this.hasMasks = true;
                        this.showStatus('‚úì Custom masks active');
                        setTimeout(() => this.hideStatus(), 2000);
                    } catch (e) {
                        console.warn('Failed to load masks for', locationName, e);
                        this.hasMasks = false;
                        this.showStatus('Using gradient effects');
                        setTimeout(() => this.hideStatus(), 2000);
                    }
                } else {
                    this.hasMasks = false;
                    // Don't show status for locations without masks - gradient fallback works silently
                    this.hideStatus();
                }
            }
            
            loadTexture(url, unit, existingTexture) {
                return new Promise((resolve, reject) => {
                    const gl = this.gl;
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        gl.activeTexture(gl.TEXTURE0 + unit);
                        gl.bindTexture(gl.TEXTURE_2D, existingTexture);
                        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);
                        gl.generateMipmap(gl.TEXTURE_2D);
                        resolve();
                    };
                    
                    img.onerror = () => reject(new Error(`Failed to load ${url}`));
                    img.src = url;
                });
            }
            
            showStatus(text) {
                if (this.statusEl && this.statusTextEl) {
                    this.statusTextEl.textContent = text;
                    this.statusEl.style.display = 'block';
                }
            }
            
            hideStatus() {
                if (this.statusEl) {
                    this.statusEl.style.display = 'none';
                }
            }
            
            setIntensities(cloud, water, veg) {
                this.cloudDrift = cloud;
                this.waterRipple = water;
                this.vegSway = veg;
            }
            
            enable() {
                if (!this.gl) {
                    if (!this.init()) return;
                }
                
                this.enabled = true;
                this.canvas.classList.add('active');
                
                // Enable sliders
                document.getElementById('scene-anim-sliders').style.opacity = '1';
                document.getElementById('scene-anim-sliders').style.pointerEvents = 'auto';
                document.getElementById('water-ripple-row').style.opacity = '1';
                document.getElementById('water-ripple-row').style.pointerEvents = 'auto';
                document.getElementById('veg-sway-row').style.opacity = '1';
                document.getElementById('veg-sway-row').style.pointerEvents = 'auto';
                
                if (!this.animating) {
                    this.startTime = performance.now();
                    this.animating = true;
                    this.animate();
                }
                
                // Load masks for current location if we have one
                if (typeof currentIndex !== 'undefined' && typeof LOCATIONS !== 'undefined') {
                    const loc = LOCATIONS[currentIndex];
                    this.loadMasksForLocation(loc.name);
                }
            }
            
            disable() {
                this.enabled = false;
                this.canvas.classList.remove('active');
                
                // Disable sliders
                document.getElementById('scene-anim-sliders').style.opacity = '0.5';
                document.getElementById('scene-anim-sliders').style.pointerEvents = 'none';
                document.getElementById('water-ripple-row').style.opacity = '0.5';
                document.getElementById('water-ripple-row').style.pointerEvents = 'none';
                document.getElementById('veg-sway-row').style.opacity = '0.5';
                document.getElementById('veg-sway-row').style.pointerEvents = 'none';
                
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                    this.animationFrame = null;
                }
                this.animating = false;
                this.hideStatus();
            }
            
            animate() {
                if (!this.enabled || !this.animating) return;
                
                const gl = this.gl;
                const time = (performance.now() - this.startTime) / 1000;
                
                gl.viewport(0, 0, this.canvas.width, this.canvas.height);
                gl.clearColor(0, 0, 0, 0);
                gl.clear(gl.COLOR_BUFFER_BIT);
                
                gl.useProgram(this.program);
                
                // Enable blending for overlay effect
                gl.enable(gl.BLEND);
                gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
                
                // Set uniforms
                gl.uniform1f(this.uniforms.time, time);
                gl.uniform1f(this.uniforms.cloudIntensity, this.cloudDrift);
                gl.uniform1f(this.uniforms.waterIntensity, this.waterRipple);
                gl.uniform1f(this.uniforms.vegIntensity, this.vegSway);
                gl.uniform2f(this.uniforms.resolution, this.canvas.width, this.canvas.height);
                gl.uniform1i(this.uniforms.hasMasks, this.hasMasks ? 1 : 0);
                
                // Bind textures
                gl.activeTexture(gl.TEXTURE0);
                gl.bindTexture(gl.TEXTURE_2D, this.skyMask);
                gl.uniform1i(this.uniforms.skyMask, 0);
                
                gl.activeTexture(gl.TEXTURE1);
                gl.bindTexture(gl.TEXTURE_2D, this.waterMask);
                gl.uniform1i(this.uniforms.waterMask, 1);
                
                gl.activeTexture(gl.TEXTURE2);
                gl.bindTexture(gl.TEXTURE_2D, this.vegMask);
                gl.uniform1i(this.uniforms.vegMask, 2);
                
                // Draw
                gl.drawArrays(gl.TRIANGLES, 0, 6);
                
                this.animationFrame = requestAnimationFrame(() => this.animate());
            }
            
            handleResize() {
                if (this.canvas) {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                }
            }
            
            getLocationSlug(locationName) {
                // Convert location name to slug format
                return locationName
                    .toLowerCase()
                    .replace(/[ ª']/g, '')
                    .replace(/[ƒÅƒìƒ´≈ç≈´]/g, c => ({ 'ƒÅ': 'a', 'ƒì': 'e', 'ƒ´': 'i', '≈ç': 'o', '≈´': 'u' })[c] || c)
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-|-$/g, '');
            }
            
            onLocationChange(location) {
                if (!this.enabled) return;
                this.loadMasksForLocation(location.name);
            }
        }
        
        // =====================================================
        // LOADING MANAGER
        // =====================================================
        class LoadingManager {
            constructor() {
                this.tipIndex = 0;
                this.tipElement = document.getElementById('loading-tip');
                this.tipInterval = null;
            }
            
            start() {
                this.rotateTips();
                this.tipInterval = setInterval(() => this.rotateTips(), 4000);
            }
            
            rotateTips() {
                this.tipElement.style.opacity = '0';
                setTimeout(() => {
                    this.tipIndex = (this.tipIndex + 1) % LOADING_TIPS.length;
                    this.tipElement.textContent = LOADING_TIPS[this.tipIndex];
                    this.tipElement.style.opacity = '1';
                }, 300);
            }
            
            stop() {
                if (this.tipInterval) {
                    clearInterval(this.tipInterval);
                    this.tipInterval = null;
                }
            }
        }
        
        // =====================================================
        // STATE
        // =====================================================
        let streetViewPanorama = null, streetViewService = null, miniMap = null, currentMarker = null, allMarkers = [];
        let currentIndex = 0, isTransitioning = false, isAutoPlaying = false, autoPlayTimer = null, mapsLoaded = false;
        const audioManager = new AudioManager();
        const atmosphereManager = new AtmosphereManager();
        const weatherManager = new WeatherManager();
        const achievementsManager = new AchievementsManager();
        const perfMonitor = new PerformanceMonitor();
        const sharingManager = new SharingManager();
        const navigator_ = new StreetViewNavigator();
        const timeTravelManager = new TimeTravelManager();
        const visualEffects = new VisualEffectsManager();
        const particleManager = new ParticleManager();
        const screenshotManager = new ScreenshotManager();
        const transitionManager = new TransitionManager();
        const loadingManager = new LoadingManager();
        const shaderAnimationManager = new ShaderAnimationManager();
        let effectStates = { ocean: true, birds: true, wind: false, volcanic: false, mist: false, vignette: false, lensflare: false, bloom: false, butterflies: false, fireflies: false, leaves: false, ash: false, spray: false, watermark: false, stamp: false, 'scene-animation': false };
        
        // =====================================================
        // HELPERS
        // =====================================================
        function showTreasure(title, message) {
            const el = document.getElementById('treasure-found');
            el.querySelector('h3').textContent = title;
            el.querySelector('p').textContent = message;
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), 3000);
        }
        
        // =====================================================
        // GOOGLE MAPS INIT
        // =====================================================
        function initMap() {
            mapsLoaded = true;
            streetViewService = new google.maps.StreetViewService();
            const streetViewContainer = document.getElementById('street-view-container');
            streetViewPanorama = new google.maps.StreetViewPanorama(streetViewContainer, {
                pov: { heading: 0, pitch: 0 }, zoom: 1, addressControl: false, showRoadLabels: false,
                linksControl: true, panControl: false, enableCloseButton: false, fullscreenControl: false,
                motionTracking: false, motionTrackingControl: false, zoomControl: false
            });
            initMiniMap();
            createLocationDots();
            populateDropdown();
            
            // Check for URL params (shared link)
            const params = sharingManager.parseUrlParams();
            if (params.locationIndex !== null && params.locationIndex >= 0 && params.locationIndex < LOCATIONS.length) {
                goToLocation(params.locationIndex, params.heading, params.pitch, params.zoom);
            } else {
                goToLocation(0);
            }
            
            setupEventListeners();
            
            streetViewPanorama.addListener('pano_changed', () => {
                document.getElementById('loading').classList.add('hidden');
                loadingManager.stop();
                perfMonitor.setLoading(false);
                navigator_.updateLinks();
                timeTravelManager.checkAvailability();
            });
            
            // Timeout fallback - if Street View doesn't load in 15 seconds, show error
            setTimeout(() => {
                const loading = document.getElementById('loading');
                if (!loading.classList.contains('hidden')) {
                    console.warn('Street View load timeout - API key may be restricted');
                    showError('Street View is taking too long to load. The Google API key may need to be configured for this domain. Try refreshing or check console for errors.');
                }
            }, 15000);
            
            // Handle Street View status errors
            streetViewPanorama.addListener('status_changed', () => {
                const status = streetViewPanorama.getStatus();
                if (status === google.maps.StreetViewStatus.ZERO_RESULTS) {
                    console.warn('No Street View imagery found for this location');
                }
            });
            
            streetViewPanorama.addListener('pov_changed', () => {
                navigator_.updateArrows();
                // Update lens flare position based on heading
                const pov = streetViewPanorama.getPov();
                visualEffects.updateSunPosition(pov.heading);
            });
            
            document.getElementById('audio-unlock').classList.add('visible');
            
            // Start performance monitor
            perfMonitor.start();
            
            // Fetch weather
            weatherManager.fetchWeather();
        }
        
        function initMiniMap() {
            const mapContainer = document.getElementById('mini-map');
            miniMap = new google.maps.Map(mapContainer, {
                center: { lat: 19.6, lng: -155.5 }, zoom: 8, mapTypeId: 'terrain', disableDefaultUI: true, gestureHandling: 'cooperative',
                styles: [
                    { elementType: 'geometry', stylers: [{ color: '#1a1a1a' }] },
                    { elementType: 'labels.text.fill', stylers: [{ color: '#7FCDCD' }] },
                    { elementType: 'labels.text.stroke', stylers: [{ color: '#1a1a1a' }] },
                    { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0D3B66' }] },
                    { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#2D2D2D' }] },
                    { featureType: 'poi', stylers: [{ visibility: 'off' }] }
                ]
            });
            LOCATIONS.forEach((loc, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: loc.lat, lng: loc.lng }, map: miniMap, title: loc.name,
                    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: index === 0 ? '#2A9D8F' : '#7FCDCD', fillOpacity: 0.9, strokeColor: '#FAF8F5', strokeWeight: 2 }
                });
                marker.addListener('click', () => goToLocation(index));
                allMarkers.push(marker);
            });
            currentMarker = allMarkers[0];
        }
        
        function createLocationDots() {
            const container = document.getElementById('location-dots');
            container.innerHTML = '';
            LOCATIONS.forEach((loc, index) => {
                const dot = document.createElement('div');
                dot.className = 'location-dot' + (index === 0 ? ' active' : '');
                if (achievementsManager.visitedLocations.has(loc.id)) dot.classList.add('visited');
                dot.title = loc.name;
                dot.setAttribute('role', 'button');
                dot.setAttribute('aria-label', `Go to ${loc.name}`);
                dot.setAttribute('tabindex', '0');
                dot.addEventListener('click', () => goToLocation(index));
                dot.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); goToLocation(index); } });
                container.appendChild(dot);
            });
        }
        
        function populateDropdown() {
            const dropdown = document.getElementById('location-dropdown');
            const regions = {};
            LOCATIONS.forEach((loc, index) => { if (!regions[loc.region]) regions[loc.region] = []; regions[loc.region].push({ ...loc, index }); });
            Object.keys(regions).forEach(region => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = `üìç ${region}`;
                regions[region].forEach(loc => { const option = document.createElement('option'); option.value = loc.index; option.textContent = loc.name; optgroup.appendChild(option); });
                dropdown.appendChild(optgroup);
            });
            dropdown.value = '0';
            dropdown.addEventListener('change', (e) => goToLocation(parseInt(e.target.value)));
        }
        
        function updateLocationDots() {
            document.querySelectorAll('.location-dot').forEach((dot, index) => {
                dot.classList.remove('active');
                if (index === currentIndex) dot.classList.add('active');
                if (achievementsManager.visitedLocations.has(LOCATIONS[index].id)) dot.classList.add('visited');
            });
        }
        
        function updateMiniMapMarkers() {
            allMarkers.forEach((marker, index) => {
                marker.setIcon({ path: google.maps.SymbolPath.CIRCLE, scale: index === currentIndex ? 8 : 6, fillColor: index === currentIndex ? '#2A9D8F' : '#7FCDCD', fillOpacity: 0.9, strokeColor: '#FAF8F5', strokeWeight: index === currentIndex ? 3 : 2 });
            });
            const loc = LOCATIONS[currentIndex];
            miniMap.panTo({ lat: loc.lat, lng: loc.lng });
        }
        
        // =====================================================
        // LOCATION NAVIGATION
        // =====================================================
        function goToLocation(index, overrideHeading, overridePitch, overrideZoom) {
            if (index < 0 || index >= LOCATIONS.length || isTransitioning) return;
            if (index === currentIndex && streetViewPanorama.getPano() && overrideHeading === undefined) return;
            isTransitioning = true;
            perfMonitor.setLoading(true);
            const location = LOCATIONS[index];
            const fromLocation = LOCATIONS[currentIndex];
            document.getElementById('loading-location-name').textContent = location.name;
            
            // Determine transition type based on distance
            const transitionType = transitionManager.getTransitionType(fromLocation, location);
            transitionManager.transitionTo(transitionType);
            
            setTimeout(() => {
                const searchLocation = new google.maps.LatLng(location.lat, location.lng);
                streetViewService.getPanorama({ location: searchLocation, radius: CONFIG.searchRadius, preference: google.maps.StreetViewPreference.NEAREST, source: google.maps.StreetViewSource.OUTDOOR }, (data, status) => {
                    if (status === google.maps.StreetViewStatus.OK) {
                        streetViewPanorama.setPano(data.location.pano);
                        streetViewPanorama.setPov({ 
                            heading: overrideHeading !== undefined ? overrideHeading : (location.heading || 0), 
                            pitch: overridePitch !== undefined ? overridePitch : (location.pitch || 0) 
                        });
                        if (overrideZoom !== undefined) streetViewPanorama.setZoom(overrideZoom);
                        currentIndex = index;
                        updateUI(location);
                        updateLocationDots();
                        updateMiniMapMarkers();
                        document.getElementById('location-dropdown').value = index;
                        updateAudioForLocation(location);
                        atmosphereManager.applyLocationAtmosphere(location);
                        achievementsManager.visitLocation(location);
                        if (location.defaultRain !== undefined) {
                            const rainSlider = document.getElementById('rain-slider');
                            rainSlider.value = location.defaultRain;
                            document.getElementById('rain-value').textContent = `${location.defaultRain}%`;
                            updateRainIntensity(location.defaultRain);
                        }
                        const foundLat = data.location.latLng.lat(), foundLng = data.location.latLng.lng();
                        const distance = getDistanceFromLatLng(location.lat, location.lng, foundLat, foundLng);
                        distance > 100 ? showCoverageStatus() : hideCoverageStatus();
                        shaderAnimationManager.onLocationChange(location);
                        transitionManager.complete().then(() => { isTransitioning = false; });
                    } else {
                        streetViewService.getPanorama({ location: searchLocation, radius: 1000, preference: google.maps.StreetViewPreference.NEAREST }, (data2, status2) => {
                            if (status2 === google.maps.StreetViewStatus.OK) {
                                streetViewPanorama.setPano(data2.location.pano);
                                streetViewPanorama.setPov({ heading: location.heading || 0, pitch: location.pitch || 0 });
                                currentIndex = index;
                                updateUI(location);
                                updateLocationDots();
                                updateMiniMapMarkers();
                                document.getElementById('location-dropdown').value = index;
                                updateAudioForLocation(location);
                                atmosphereManager.applyLocationAtmosphere(location);
                                achievementsManager.visitLocation(location);
                                showCoverageStatus();
                                shaderAnimationManager.onLocationChange(location);
                                transitionManager.complete().then(() => { isTransitioning = false; });
                            } else {
                                showError(`No Street View coverage near ${location.name}`);
                                transitionManager.complete();
                                isTransitioning = false;
                                perfMonitor.setLoading(false);
                                setTimeout(() => { hideError(); nextLocation(); }, 2000);
                            }
                        });
                    }
                });
            }, CONFIG.transitionDuration / 2);
        }
        
        function updateAudioForLocation(location) {
            if (!audioManager.initialized) return;
            const targetMix = {};
            if (location.audio) {
                for (const [track, volume] of Object.entries(location.audio)) {
                    if (effectStates[track] !== false) targetMix[track] = volume;
                }
            }
            for (const [effect, enabled] of Object.entries(effectStates)) {
                if (!enabled) targetMix[effect] = 0;
            }
            audioManager.crossfadeTo(targetMix);
        }
        
        function nextLocation() { goToLocation((currentIndex + 1) % LOCATIONS.length); }
        function prevLocation() { goToLocation((currentIndex - 1 + LOCATIONS.length) % LOCATIONS.length); }
        
        // Go to a custom searched location (not in predefined list)
        function goToCustomLocation(lat, lng, name) {
            if (isTransitioning) return;
            isTransitioning = true;
            perfMonitor.setLoading(true);
            document.getElementById('loading-location-name').textContent = name;
            
            transitionManager.transitionTo('blur');
            
            setTimeout(() => {
                const searchLocation = new google.maps.LatLng(lat, lng);
                streetViewService.getPanorama({ location: searchLocation, radius: 500, preference: google.maps.StreetViewPreference.NEAREST, source: google.maps.StreetViewSource.OUTDOOR }, (data, status) => {
                    if (status === google.maps.StreetViewStatus.OK) {
                        streetViewPanorama.setPano(data.location.pano);
                        streetViewPanorama.setPov({ heading: 0, pitch: 0 });
                        
                        // Update UI with custom location
                        document.getElementById('location-name').textContent = name;
                        document.getElementById('location-desc').textContent = `Custom destination ‚Ä¢ ${lat.toFixed(4)}¬∞, ${lng.toFixed(4)}¬∞`;
                        document.getElementById('location-summary').style.display = 'none';
                        document.getElementById('location-counter').textContent = 'Custom Location';
                        document.getElementById('location-dropdown').value = '';
                        
                        // Set neutral audio
                        audioManager.crossfadeTo({ wind: 0.3, birds: 0.3 });
                        atmosphereManager.setMist(false);
                        
                        // Pan mini map
                        miniMap.panTo({ lat, lng });
                        
                        transitionManager.complete().then(() => { isTransitioning = false; });
                    } else {
                        showError(`No Street View coverage at ${name}`);
                        transitionManager.complete();
                        isTransitioning = false;
                        perfMonitor.setLoading(false);
                        setTimeout(hideError, 3000);
                    }
                });
            }, CONFIG.transitionDuration / 2);
        }
        function updateUI(location) {
            document.getElementById('location-name').textContent = location.name;
            document.getElementById('location-desc').textContent = location.desc;
            document.getElementById('location-counter').textContent = `Location ${currentIndex + 1} of ${LOCATIONS.length}`;
            
            // Show summary for tour locations
            const summaryEl = document.getElementById('location-summary');
            if (location.summary) {
                summaryEl.textContent = location.summary;
                summaryEl.style.display = 'block';
            } else {
                summaryEl.style.display = 'none';
            }
        }
        
        // =====================================================
        // HELPERS
        // =====================================================
        function getDistanceFromLatLng(lat1, lng1, lat2, lng2) {
            const R = 6371000, dLat = (lat2 - lat1) * Math.PI / 180, dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function showError(message) { 
            const el = document.getElementById('error-message'); 
            el.querySelector('p').textContent = message; 
            el.classList.add('visible'); 
            // Also hide loading screen when showing error
            document.getElementById('loading').classList.add('hidden');
            loadingManager.stop();
        }
        function hideError() { document.getElementById('error-message').classList.remove('visible'); }
        function showCoverageStatus() { document.getElementById('coverage-status').classList.add('visible'); setTimeout(hideCoverageStatus, 3000); }
        function hideCoverageStatus() { document.getElementById('coverage-status').classList.remove('visible'); }
        
        // =====================================================
        // EVENT LISTENERS
        // =====================================================
        function setupEventListeners() {
            document.getElementById('prev-btn').addEventListener('click', prevLocation);
            document.getElementById('next-btn').addEventListener('click', nextLocation);
            document.getElementById('play-btn').addEventListener('click', toggleAutoPlay);
            document.addEventListener('keydown', onKeyDown);
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
            document.getElementById('audio-unlock').addEventListener('click', async () => { await audioManager.init(); updateAudioForLocation(LOCATIONS[currentIndex]); });
            
            document.querySelectorAll('.toggle-switch').forEach(toggle => {
                const handleToggle = () => {
                    toggle.classList.toggle('on');
                    const effect = toggle.dataset.effect;
                    const isOn = toggle.classList.contains('on');
                    toggle.setAttribute('aria-checked', isOn);
                    effectStates[effect] = isOn;
                    
                    // Handle different effect types
                    switch(effect) {
                        case 'mist':
                            atmosphereManager.setMist(isOn, LOCATIONS[currentIndex]?.atmosphere?.volcanic);
                            break;
                        case 'vignette':
                            visualEffects.setVignette(isOn);
                            break;
                        case 'lensflare':
                            visualEffects.setLensFlare(isOn);
                            break;
                        case 'bloom':
                            visualEffects.setBloom(isOn, atmosphereManager.currentTime === 'golden' ? 'golden' : 'day');
                            break;
                        case 'butterflies':
                            particleManager.toggleButterflies(isOn);
                            break;
                        case 'fireflies':
                            particleManager.toggleFireflies(isOn);
                            break;
                        case 'leaves':
                            particleManager.toggleLeaves(isOn);
                            break;
                        case 'ash':
                            particleManager.toggleAsh(isOn);
                            break;
                        case 'spray':
                            particleManager.toggleSpray(isOn);
                            break;
                        case 'watermark':
                            screenshotManager.setWatermark(isOn);
                            break;
                        case 'stamp':
                            screenshotManager.setStamp(isOn);
                            break;
                        case 'scene-animation':
                            if (isOn) {
                                shaderAnimationManager.enable();
                            } else {
                                shaderAnimationManager.disable();
                            }
                            break;
                        default:
                            // Audio tracks
                            audioManager.toggleTrack(effect, isOn);
                    }
                };
                toggle.addEventListener('click', handleToggle);
                toggle.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleToggle(); } });
            });
            
            // Scene Animation sliders (with null checks)
            const cloudSlider = document.getElementById('cloud-drift-slider');
            const waterSlider = document.getElementById('water-ripple-slider');
            const vegSlider = document.getElementById('veg-sway-slider');
            
            if (cloudSlider) {
                cloudSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    const valueEl = document.getElementById('cloud-drift-value');
                    if (valueEl) valueEl.textContent = `${value}%`;
                    shaderAnimationManager.cloudDrift = value / 100;
                });
            }
            
            if (waterSlider) {
                waterSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    const valueEl = document.getElementById('water-ripple-value');
                    if (valueEl) valueEl.textContent = `${value}%`;
                    shaderAnimationManager.waterRipple = value / 100;
                });
            }
            
            if (vegSlider) {
                vegSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    const valueEl = document.getElementById('veg-sway-value');
                    if (valueEl) valueEl.textContent = `${value}%`;
                    shaderAnimationManager.vegSway = value / 100;
                });
            }
            
            // Color grade selector (if it exists)
            const colorGradeSelect = document.getElementById('color-grade-select');
            if (colorGradeSelect) {
                colorGradeSelect.addEventListener('change', (e) => {
                    visualEffects.setColorGrade(e.target.value);
                });
            }
            
            // Screenshot button
            const screenshotBtn = document.getElementById('take-screenshot-btn');
            if (screenshotBtn) {
                screenshotBtn.addEventListener('click', () => {
                    screenshotManager.takeScreenshot();
                });
            }
            
            const rainSlider = document.getElementById('rain-slider');
            if (rainSlider) {
                rainSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    const rainValue = document.getElementById('rain-value');
                    if (rainValue) rainValue.textContent = `${value}%`;
                    updateRainIntensity(value);
                });
            }
            
            const windSlider = document.getElementById('wind-slider');
            if (windSlider) {
                windSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    const windValue = document.getElementById('wind-value');
                    if (windValue) windValue.textContent = `${value}%`;
                    updateWindStrength(value);
                });
            }
            
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    atmosphereManager.setTimeOfDay(btn.dataset.time);
                });
            });
            
            const volumeSlider = document.getElementById('volume-slider');
            if (volumeSlider) {
                volumeSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    const volumeValue = document.getElementById('volume-value');
                    if (volumeValue) volumeValue.textContent = `${value}%`;
                    audioManager.setMasterVolume(value / 100);
                });
            }
            
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && isAutoPlaying) clearInterval(autoPlayTimer);
                else if (!document.hidden && isAutoPlaying) autoPlayTimer = setInterval(nextLocation, CONFIG.autoPlayInterval);
            });
            document.addEventListener('click', () => audioManager.resume(), { once: true });
            
            // Navigation arrows
            document.getElementById('nav-forward').addEventListener('click', () => navigator_.moveForward());
            document.getElementById('nav-backward').addEventListener('click', () => navigator_.moveBackward());
            document.getElementById('nav-left').addEventListener('click', () => navigator_.turnLeft());
            document.getElementById('nav-right').addEventListener('click', () => navigator_.turnRight());
            
            // Weather sync
            document.getElementById('weather-sync-btn').addEventListener('click', () => weatherManager.syncAmbientEffects());
            
            // Effects panel minimize toggle
            document.getElementById('effects-header').addEventListener('click', () => {
                const content = document.getElementById('effects-content');
                const toggle = document.getElementById('effects-toggle');
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    toggle.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    toggle.textContent = '‚ñ∂';
                }
            });
            
            // Destination search with autocomplete
            const searchInput = document.getElementById('destination-search');
            const suggestionsBox = document.getElementById('search-suggestions');
            let autocompleteService = null;
            let placesService = null;
            
            // Initialize Places Autocomplete after map loads
            if (google.maps.places) {
                autocompleteService = new google.maps.places.AutocompleteService();
                placesService = new google.maps.places.PlacesService(miniMap);
            }
            
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query.length < 2) {
                    suggestionsBox.style.display = 'none';
                    return;
                }
                
                if (autocompleteService) {
                    autocompleteService.getPlacePredictions({
                        input: query,
                        locationBias: { center: { lat: 19.6, lng: -155.5 }, radius: 100000 }, // Big Island area
                        types: ['establishment', 'geocode', 'point_of_interest']
                    }, (predictions, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                            suggestionsBox.innerHTML = '';
                            predictions.slice(0, 5).forEach(pred => {
                                const div = document.createElement('div');
                                div.className = 'search-suggestion';
                                div.innerHTML = `
                                    <div class="search-suggestion-name">${pred.structured_formatting.main_text}</div>
                                    <div class="search-suggestion-address">${pred.structured_formatting.secondary_text || ''}</div>
                                `;
                                div.addEventListener('click', () => {
                                    placesService.getDetails({ placeId: pred.place_id, fields: ['geometry', 'name'] }, (place, detailStatus) => {
                                        if (detailStatus === google.maps.places.PlacesServiceStatus.OK && place.geometry) {
                                            goToCustomLocation(place.geometry.location.lat(), place.geometry.location.lng(), pred.structured_formatting.main_text);
                                        }
                                    });
                                    suggestionsBox.style.display = 'none';
                                    searchInput.value = pred.structured_formatting.main_text;
                                });
                                suggestionsBox.appendChild(div);
                            });
                            suggestionsBox.style.display = 'block';
                        } else {
                            suggestionsBox.style.display = 'none';
                        }
                    });
                }
            });
            
            searchInput.addEventListener('focus', () => {
                if (searchInput.value.length >= 2 && suggestionsBox.children.length > 0) {
                    suggestionsBox.style.display = 'block';
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                    suggestionsBox.style.display = 'none';
                }
            });
            
            // Share panel
            document.getElementById('share-btn').addEventListener('click', () => {
                const panel = document.getElementById('share-panel');
                panel.classList.toggle('visible');
                if (panel.classList.contains('visible')) sharingManager.updatePanel();
            });
            document.getElementById('share-close').addEventListener('click', () => {
                document.getElementById('share-panel').classList.remove('visible');
            });
            document.getElementById('share-twitter').addEventListener('click', () => sharingManager.shareTwitter());
            document.getElementById('share-facebook').addEventListener('click', () => sharingManager.shareFacebook());
            document.getElementById('share-linkedin').addEventListener('click', () => sharingManager.shareLinkedIn());
            document.getElementById('share-copy').addEventListener('click', () => sharingManager.copyUrl());
            document.getElementById('copy-embed').addEventListener('click', () => sharingManager.copyEmbed());
            
            // Performance dashboard
            document.getElementById('perf-btn').addEventListener('click', () => perfMonitor.toggle());
        }
        
        function onKeyDown(e) {
            // Disable shortcuts when search input is focused
            const searchInput = document.getElementById('destination-search');
            if (document.activeElement === searchInput) {
                return; // Don't process shortcuts while typing in search
            }
            
            switch(e.key) {
                case 'ArrowRight': nextLocation(); break;
                case 'ArrowLeft': prevLocation(); break;
                case ' ': e.preventDefault(); toggleAutoPlay(); break;
                case 'h': case 'H': toggleUIVisibility(); break;
                case 'f': case 'F': toggleFullscreen(); break;
                case 'p': case 'P': perfMonitor.toggle(); break;
                case 'w': case 'W': navigator_.moveForward(); break;
                case 's': case 'S': navigator_.moveBackward(); break;
                case 'a': case 'A': navigator_.turnLeft(); break;
                case 'd': case 'D': navigator_.turnRight(); break;
                case 'm': case 'M':
                    const volumeSlider = document.getElementById('volume-slider');
                    if (audioManager.masterVolume > 0) { audioManager.setMasterVolume(0); volumeSlider.value = 0; document.getElementById('volume-value').textContent = '0%'; }
                    else { audioManager.setMasterVolume(0.8); volumeSlider.value = 80; document.getElementById('volume-value').textContent = '80%'; }
                    break;
            }
        }
        
        function toggleAutoPlay() {
            isAutoPlaying = !isAutoPlaying;
            const btn = document.getElementById('play-btn'), icon = document.getElementById('play-icon'), text = document.getElementById('play-text');
            if (isAutoPlaying) { icon.textContent = '‚è∏Ô∏è'; text.textContent = 'Pause'; btn.classList.add('active'); autoPlayTimer = setInterval(nextLocation, CONFIG.autoPlayInterval); }
            else { icon.textContent = '‚ñ∂Ô∏è'; text.textContent = 'Auto Tour'; btn.classList.remove('active'); clearInterval(autoPlayTimer); }
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => console.log('Fullscreen error:', err));
            else document.exitFullscreen();
        }
        
        let uiHidden = false;
        function toggleUIVisibility() {
            uiHidden = !uiHidden;
            const elements = ['#controls', '#info', '#mini-map-container', '#effects-panel', '#achievements-panel', 
                             '#nav-arrows', '#keyboard-help', '#weather-panel', '#vignette-layer', '#bloom-layer', 
                             '#lens-flare', '.nav-arrow', '#treasure-popup'];
            elements.forEach(sel => {
                document.querySelectorAll(sel).forEach(el => {
                    el.style.display = uiHidden ? 'none' : '';
                });
            });
            if (!uiHidden) {
                // Restore default display values
                document.querySelectorAll('#controls, #info').forEach(el => el.style.display = 'block');
            }
            showTreasure(uiHidden ? 'üëÅÔ∏è UI Hidden' : 'üëÅÔ∏è UI Visible', 
                        uiHidden ? 'Press H again to show. Take screenshot now!' : 'All controls restored');
        }
        
        // =====================================================
        // RAIN EFFECT
        // =====================================================
        const rainCanvas = document.getElementById('rain-canvas');
        const rainCtx = rainCanvas.getContext('2d');
        let raindrops = [], rainActive = false, rainAnimationFrame = null, currentWindStrength = 0.2;
        
        function initRain() { rainCanvas.width = window.innerWidth; rainCanvas.height = window.innerHeight; raindrops = []; }
        
        function createRaindrops(intensity) {
            const count = Math.floor(intensity * 3);
            raindrops = [];
            for (let i = 0; i < count; i++) {
                raindrops.push({ x: Math.random() * rainCanvas.width, y: Math.random() * rainCanvas.height, length: Math.random() * 15 + 10, speed: Math.random() * 10 + 15, opacity: Math.random() * 0.3 + 0.1 });
            }
        }
        
        function updateRain() {
            if (!rainActive) return;
            rainCtx.clearRect(0, 0, rainCanvas.width, rainCanvas.height);
            const windAngle = currentWindStrength * 0.5;
            raindrops.forEach(drop => {
                rainCtx.beginPath();
                rainCtx.moveTo(drop.x, drop.y);
                rainCtx.lineTo(drop.x + Math.sin(windAngle) * drop.length, drop.y + Math.cos(windAngle) * drop.length);
                rainCtx.strokeStyle = `rgba(174, 194, 224, ${drop.opacity})`;
                rainCtx.lineWidth = 1;
                rainCtx.stroke();
                drop.y += drop.speed;
                drop.x += currentWindStrength * 2;
                if (drop.y > rainCanvas.height || drop.x > rainCanvas.width) { drop.y = -drop.length; drop.x = Math.random() * rainCanvas.width; }
            });
            rainAnimationFrame = requestAnimationFrame(updateRain);
        }
        
        function updateRainIntensity(intensity) {
            audioManager.setRainIntensity(intensity);
            if (intensity > 0) {
                if (!rainActive) { rainActive = true; rainCanvas.classList.add('active'); updateRain(); }
                createRaindrops(intensity);
            } else {
                rainActive = false;
                rainCanvas.classList.remove('active');
                if (rainAnimationFrame) cancelAnimationFrame(rainAnimationFrame);
            }
        }
        
        function updateWindStrength(strength) { currentWindStrength = strength / 100; audioManager.setWindStrength(strength); }
        
        window.addEventListener('resize', () => { rainCanvas.width = window.innerWidth; rainCanvas.height = window.innerHeight; });
        
        // =====================================================
        // INITIALIZE
        // =====================================================
        initRain();
        loadingManager.start();
        
        function loadGoogleMapsAPI() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=places&callback=initMap`;
            script.async = true;
            script.defer = true;
            script.onerror = () => showError('Failed to load Google Maps. Please check your internet connection.');
            document.head.appendChild(script);
        }
        
        window.initMap = initMap;
        loadGoogleMapsAPI();
    </script>
</body>
</html>
